<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SAR Online - Hangdong Ratratupathum</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Phosphor Icons -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --k-red: #e11d48; --k-soft-red: #fff1f2; --k-border: #fecdd3; --k-bg: #f8fafc; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--k-bg); color: #1e293b; font-size: 14px; -webkit-tap-highlight-color: transparent; }
        
        /* General UI */
        .k-card { background: white; border: 1px solid var(--k-border); border-radius: 12px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); margin-bottom: 1.5rem; padding: 1.5rem; }
        .k-input { width: 100%; padding: 10px; border: 1px solid var(--k-border); border-radius: 6px; outline: none; font-size: 14px; background: white; min-height: 42px; }
        .k-input:focus { border-color: var(--k-red); box-shadow: 0 0 0 2px var(--k-soft-red); }
        
        table .k-input { border: none !important; background: transparent !important; box-shadow: none !important; padding: 6px 4px; border-radius: 0; min-height: auto; }
        table .k-input:focus { border-bottom: 1px dashed #ccc !important; }

        .k-label { font-weight: 700; font-size: 13px; color: #475569; margin-bottom: 6px; display: block; }
        
        /* Table Styles (Screen) */
        .table-responsive { overflow-x: auto; -webkit-overflow-scrolling: touch; margin-bottom: 10px; border-radius: 8px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        
        th { background-color: var(--k-soft-red); color: var(--k-red); padding: 10px 4px; border: 1px solid var(--k-border); font-size: 13px; font-weight: 800; white-space: nowrap; }
        td { padding: 6px 4px; border: 1px solid var(--k-border); text-align: center; vertical-align: top; }
        
        textarea.k-input { min-height: 42px; overflow-y: hidden; resize: none; line-height: 1.4; }

        .btn-add { border: 2px dashed var(--k-red); color: var(--k-red); padding: 8px 16px; border-radius: 8px; font-weight: 700; cursor: pointer; margin-top: 10px; display: inline-block; font-size: 13px; background: transparent; transition: 0.2s; width: 100%; text-align: center; }
        .btn-add:hover { background: var(--k-red); color: white; }
        
        /* Sidebar */
        .sidebar-item { cursor: pointer; padding: 12px 16px; border-radius: 10px; margin-bottom: 6px; transition: 0.2s; display: flex; align-items: center; gap: 10px; color: #64748b; font-weight: 500; white-space: nowrap; }
        .sidebar-item.active { background-color: var(--k-red); color: white; font-weight: 700; box-shadow: 0 4px 12px rgba(225, 29, 72, 0.25); }
        .sidebar-item:hover:not(.active) { background-color: var(--k-soft-red); color: var(--k-red); }

        .summary-box { background: #f1f5f9; padding: 15px; border-radius: 10px; font-weight: 700; color: #334155; border: 1px solid #e2e8f0; margin-top: 10px; }
        .badge { padding: 4px 12px; border-radius: 99px; font-weight: bold; font-size: 12px; white-space: nowrap; display: inline-block; }
        .badge-success { background: #dcfce7; color: #166534; }
        .badge-fail { background: #fee2e2; color: #991b1b; }

        .row-num::before { content: attr(data-index); }

        #photo-preview, #sig-preview { border: 2px dashed #cbd5e1; border-radius: 8px; display: flex; align-items: center; justify-content: center; overflow: hidden; margin: 0 auto; }
        #photo-preview { width: 150px; height: 180px; background: #f8fafc; }
        #sig-preview { width: 200px; height: 100px; background: white; }
        #photo-preview img, #sig-preview img { width: 100%; height: 100%; object-fit: contain; }

        .mini-summary-table { width: 100%; margin-top: 8px; border: 1px solid #e2e8f0; min-width: auto; }
        .mini-summary-table th { background: #f8fafc; color: #475569; font-size: 11px; padding: 4px; border: 1px solid #e2e8f0; text-align: center; }
        .mini-summary-table td { background: #fff; color: #1e293b; font-size: 12px; font-weight: bold; padding: 6px; border: 1px solid #e2e8f0; text-align: center; }
        
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 9999; align-items: center; justify-content: center; flex-direction: column; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid var(--k-red); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Image Grid */
        .table-upload-btn { background-color: #f0f9ff; color: #0369a1; border: 1px dashed #bae6fd; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; transition: 0.2s; display: inline-flex; align-items: center; gap: 4px; width: 100%; justify-content: center; margin-bottom: 5px; }
        .table-img-preview-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 4px; width: 100%; }
        .img-wrapper { position: relative; width: 100%; aspect-ratio: 1/1; border: 1px solid #cbd5e1; border-radius: 4px; overflow: hidden; background: #fff; }
        .table-img-preview { width: 100%; height: 100%; object-fit: cover; display: block; }
        .remove-img-btn { position: absolute; top: 0; right: 0; background: rgba(255,255,255,0.8); color: red; font-size: 10px; width: 16px; height: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 0 0 0 4px; }

        @media print { .no-print { display: none !important; } body { background: white; } }
        
        /* --- PDF MODE (Strict Layout Control) --- */
        .pdf-mode {
            /* Fix #5: Fit to A4 width strictly */
            width: 790px !important; 
            max-width: 790px !important;
            margin: 0 auto !important;
            padding: 0 10px !important; /* Small padding inside */
            background: white !important;
            font-size: 12px !important;
        }

        .pdf-mode #printable-content { width: 100% !important; margin: 0 !important; padding: 0 !important; }
        .pdf-mode .tab-content { display: block !important; margin-bottom: 0px; }
        .pdf-mode .no-print { display: none !important; }
        
        /* Fix #3: Force New Page for Main Sections */
        .section-break { 
            page-break-before: always !important; 
            break-before: page !important;
            margin-top: 0 !important; 
            padding-top: 20px !important;
        }

        /* Fix #4: Avoid breaking inside Sub-sections */
        .avoid-break { 
            page-break-inside: avoid !important; 
            break-inside: avoid !important; 
            display: block; 
            position: relative; 
            margin-bottom: 1.5rem; 
        }

        .pdf-mode .k-card { 
            box-shadow: none !important; 
            border: 1px solid #ccc !important; 
            margin-bottom: 15px !important; 
            padding: 15px !important;
            page-break-inside: avoid; /* Keep cards together */
        }
        
        .pdf-mode table { 
            width: 100% !important; 
            table-layout: fixed !important; /* Critical for layout */
            border-collapse: collapse !important;
        }
        
        /* Fix #2: Improve Text Rendering */
        .pdf-mode th, .pdf-mode td {
            font-size: 12px !important; 
            padding: 4px !important;
            word-wrap: break-word !important; 
            white-space: normal !important;
            vertical-align: top !important;
            line-height: 1.4 !important;
            letter-spacing: 0.2px; /* Slight spacing to prevent overlap */
            text-rendering: optimizeLegibility;
        }
        
        .pdf-mode .table-img-preview-container { gap: 2px !important; }
        .pdf-mode .img-wrapper { border: none !important; }
        .pdf-mode .section-header { padding-top: 5px !important; margin-bottom: 15px !important; border-bottom: 2px solid #fecdd3; }
        .pdf-mode .pdf-cover-page { display: flex !important; }
        
        /* Text Replacement in PDF Mode */
        .pdf-text-val { display: none; white-space: pre-wrap; word-break: break-word; font-size: 12px; font-weight: 500; line-height: 1.5; color: #000; }
        .pdf-mode .k-input, .pdf-mode textarea, .pdf-mode select { display: none !important; }
        .pdf-mode .pdf-text-val { display: block; }
        
        .pdf-cover-page { display: none; flex-direction: column; align-items: center; justify-content: center; padding-top: 40px; text-align: center; width: 100%; height: 1100px; /* Force full page height */ page-break-after: always; }
        
        .date-display { font-size: 13px; font-weight: bold; color: var(--k-red); margin-top: 4px; }
        
        @media (max-width: 768px) {
            body { flex-direction: column; }
            aside { width: 100%; height: auto; position: sticky; top: 0; z-index: 40; }
            main { padding: 10px; padding-bottom: 80px; }
        }
        @media (min-width: 769px) { aside { height: 100vh; overflow-y: auto; } }
    </style>
</head>
<body class="flex flex-col md:flex-row min-h-screen bg-slate-50">
    <div id="loading-overlay">
        <div class="spinner mb-4"></div>
        <div class="text-rose-600 font-bold text-lg">กำลังประมวลผล...</div>
        <div class="text-slate-500 text-sm mt-2 text-center">กำลังจัดหน้าและบันทึกข้อมูล</div>
    </div>
    
    <aside class="no-print bg-white border-r border-rose-100 flex flex-col shrink-0 md:w-72">
        <div class="mb-4 flex flex-col items-start justify-start sidebar-header p-4 w-full">
            <img src="https://img2.imgbiz.com/imgbiz/images525f26dacc70d0c1.jpg" alt="School Logo" class="object-contain school-logo mb-3" style="max-width: 150px; width: 100%; height: auto; display: block;">
            <div class="flex flex-col items-start w-full">
                <h1 class="text-lg lg:text-xl font-black text-rose-600 tracking-tighter flex items-center gap-2 sidebar-title"><i class="ph ph-files text-xl lg:text-2xl"></i> SAR ONLINE</h1>
                <p class="text-[10px] text-slate-400 font-bold uppercase tracking-widest">Hangdong Ratratupathum</p>
            </div>
        </div>
        <nav class="px-4">
            <div onclick="showTab(1)" id="tab-1" class="sidebar-item active"><i class="ph ph-user"></i> <span class="hidden md:inline">1. ข้อมูลส่วนตัว</span><span class="md:hidden">ส่วนตัว</span></div>
            <div onclick="showTab(2)" id="tab-2" class="sidebar-item"><i class="ph ph-chalkboard-teacher"></i> <span class="hidden md:inline">2. การปฏิบัติหน้าที่</span><span class="md:hidden">หน้าที่</span></div>
            <div onclick="showTab(3)" id="tab-3" class="sidebar-item"><i class="ph ph-presentation-chart"></i> <span class="hidden md:inline">3. การพัฒนาการสอน</span><span class="md:hidden">การสอน</span></div>
            <div onclick="showTab(4)" id="tab-4" class="sidebar-item"><i class="ph ph-star"></i> <span class="hidden md:inline">4. การพัฒนาตนเอง</span><span class="md:hidden">พัฒนาตน</span></div>
            <div onclick="showTab(5)" id="tab-5" class="sidebar-item"><i class="ph ph-trophy"></i> <span class="hidden md:inline">5. ผลงานภาคภูมิใจ</span><span class="md:hidden">ผลงาน</span></div>
            <div onclick="showTab(6)" id="tab-6" class="sidebar-item"><i class="ph ph-trend-up"></i> <span class="hidden md:inline">6. ผลการปฏิบัติงาน</span><span class="md:hidden">ผลประเมิน</span></div>
            <div onclick="showTab(7)" id="tab-7" class="sidebar-item"><i class="ph ph-clipboard-text"></i> <span class="hidden md:inline">7. ประเมินแผนการสอน</span><span class="md:hidden">แผนฯ</span></div>
            <div onclick="showTab(8)" id="tab-8" class="sidebar-item"><i class="ph ph-buildings"></i> <span class="hidden md:inline">8. มาตรฐานการศึกษา</span><span class="md:hidden">มาตรฐาน</span></div>
        </nav>
        <div class="mt-auto border-t pt-6 p-4 hidden md:block">
            <button onclick="saveAndUpload()" class="w-full bg-green-600 text-white py-3 px-4 rounded-xl font-bold shadow-lg hover:bg-green-700 transition active:scale-95 flex items-center justify-center gap-2 text-sm"><i class="ph ph-cloud-arrow-up text-lg"></i> บันทึกข้อมูลและส่งออก PDF</button>
        </div>
    </aside>

    <main class="flex-grow w-full max-w-[1200px] mx-auto p-4 md:p-8" id="printable-content">
        <div id="pdf-cover" class="pdf-cover-page">
            <div class="flex flex-col items-center justify-center h-full w-full gap-4">
                <img src="https://img2.imgbiz.com/imgbiz/images525f26dacc70d0c1.jpg" style="max-width: 150px; width: 100%; height: auto;" class="mb-4 school-logo">
                <h1 class="text-3xl font-black text-rose-800 leading-tight">รายงานการประเมินตนเอง<br>(Self-Assessment Report : SAR)</h1>
                <div class="bg-rose-50 px-8 py-4 rounded-2xl border border-rose-200 shadow-sm mt-4"><p class="text-xl text-rose-700 font-bold mb-1">โรงเรียนหางดงรัฐราษฎร์อุปถัมภ์</p><p class="text-md text-slate-500">สำนักงานเขตพื้นที่การศึกษามัธยมศึกษาเชียงใหม่</p></div>
                <div class="flex items-center justify-center gap-2 mt-4"><span class="text-xl font-bold text-slate-600">ประจำปีการศึกษา</span><span id="cover-year-display" class="text-xl font-bold text-slate-800">2568</span></div>
                <div id="cover-photo-container" class="mt-6 mb-6 w-40 h-52 border-2 border-dashed border-rose-200 bg-slate-50 flex items-center justify-center overflow-hidden rounded-lg shadow-sm"><span class="text-slate-300 text-xs">รูปถ่าย</span></div>
                <div class="text-xl font-bold text-slate-700 mt-2">ผู้รายงาน: <span id="cover-name-display" class="text-rose-600 text-2xl">...</span></div>
            </div>
        </div>

        <div id="section-1" class="tab-content">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">1</div><h2 class="text-2xl font-black text-rose-700">ข้อมูลทั่วไป</h2>
            </div>
            <div class="k-card">
                <div class="flex flex-col lg:flex-row gap-8">
                    <div class="shrink-0 flex flex-col items-center gap-4 w-full lg:w-auto">
                        <div id="photo-preview"><span class="text-slate-400 text-xs flex flex-col items-center gap-1"><i class="ph ph-camera text-2xl"></i>รูปถ่าย</span></div>
                        <input type="file" id="photo-input" accept="image/*" class="hidden" onchange="previewImage(this)">
                        <button onclick="document.getElementById('photo-input').click()" class="no-print text-xs font-bold text-rose-600 border border-rose-600 px-3 py-2 rounded-md hover:bg-rose-50 transition w-full lg:w-auto"><i class="ph ph-upload-simple"></i> อัปโหลดรูป</button>
                    </div>
                    <div class="flex-grow grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2"><label class="k-label">ชื่อ - นามสกุล</label><input type="text" id="t-name" class="k-input" placeholder="นาย/นาง/นางสาว ..."></div>
                        <div><label class="k-label text-rose-600">ประจำปีการศึกษา</label><input type="number" id="input-year" value="2568" class="k-input font-bold text-rose-700 bg-rose-50"></div>
                        <div>
                            <label class="k-label">วัน/เดือน/ปี เกิด</label>
                            <input type="date" class="k-input" id="birthdate" onchange="calcAge('birthdate', 'age-res', 'birthdate-display')">
                            <div id="birthdate-display" class="date-display"></div>
                        </div>
                        <div><label class="k-label">อายุปัจจุบัน</label><input type="text" class="k-input bg-slate-50 font-bold" id="age-res" readonly></div>
                        <div>
                            <label class="k-label">วัน/เดือน/ปี บรรจุเข้ารับราชการ</label>
                            <input type="date" class="k-input" id="workdate" onchange="calcAge('workdate', 'work-res', 'workdate-display')">
                            <div id="workdate-display" class="date-display"></div>
                        </div>
                        <div><label class="k-label">อายุราชการ</label><input type="text" class="k-input bg-slate-50 font-bold" id="work-res" readonly></div>
                        <div><label class="k-label">ตำแหน่ง</label><select class="k-input" id="t-position"><option>ครูผู้ช่วย</option><option>ครู</option><option>อัตราจ้าง</option></select></div>
                        <div><label class="k-label">วิทยฐานะ</label><select class="k-input" id="t-academic"><option>ไม่มี</option><option>ชำนาญการ</option><option>ชำนาญการพิเศษ</option><option>เชี่ยวชาญ</option><option>เชี่ยวชาญพิเศษ</option></select></div>
                        <div><label class="k-label">เลขที่ตำแหน่ง</label><input type="text" class="k-input" id="t-id"></div>
                        <div><label class="k-label">เงินเดือน</label><input type="number" class="k-input" id="t-salary"></div>
                        <div><label class="k-label">เงินวิทยฐานะ</label><input type="number" class="k-input" id="t-academic-salary"></div>
                        <div><label class="k-label">กลุ่มสาระการเรียนรู้</label><input type="text" class="k-input" id="t-group"></div>
                        <div><label class="k-label">สังกัดกลุ่มงาน</label><input type="text" class="k-input" id="t-subgroup"></div>
                    </div>
                </div>
            </div>
            <div class="k-card">
                <h3 class="font-bold text-rose-600 mb-4 flex items-center gap-2"><i class="ph ph-graduation-cap text-lg"></i> ประวัติการศึกษา</h3>
                <div class="table-responsive"><table id="edu-table"><thead><tr><th width="5%">ลำดับ</th><th width="25%">วุฒิการศึกษา</th><th width="25%">วิชาเอก</th><th width="40%">สถาบัน</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div>
                <button onclick="addRow('edu-table')" class="btn-add no-print">+ เพิ่มวุฒิการศึกษา</button>
            </div>
        </div>

        <div id="section-2" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">2</div><h2 class="text-2xl font-black text-rose-700">การปฏิบัติหน้าที่</h2>
            </div>
            
            <div class="k-card">
                <h3 class="font-bold text-rose-600 mb-4 text-lg">2.1 ปฏิบัติการสอน</h3>
                <!-- FIX #4: Grouped Header and Table with avoid-break -->
                <div class="avoid-break mb-8">
                    <h4 class="text-sm font-bold text-slate-600 mb-2 border-l-4 border-slate-300 pl-2">ภาคเรียนที่ 1</h4>
                    <div class="table-responsive"><table id="teach-t1"><thead><tr><th width="5%">ที่</th><th width="15%">รหัส</th><th width="30%">ชื่อวิชา</th><th width="10%">ชั้น</th><th width="10%">ห้อง</th><th width="15%">ชม./สัปดาห์</th><th width="10%">พิเศษ</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody><tfoot><tr class="bg-slate-50 font-bold"><td colspan="3">รวม</td><td id="t1-sum-grade">-</td><td id="t1-sum-room">0</td><td id="t1-sum-hour">0</td><td id="t1-sum-special">0</td><td class="no-print"></td></tr></tfoot></table></div>
                    <button onclick="addTeachRow('teach-t1')" class="btn-add no-print">+ เพิ่มวิชา</button>
                </div>
                <!-- FIX #4: Grouped Header and Table with avoid-break -->
                <div class="avoid-break mb-4">
                    <h4 class="text-sm font-bold text-slate-600 mb-2 border-l-4 border-slate-300 pl-2">ภาคเรียนที่ 2</h4>
                    <div class="table-responsive"><table id="teach-t2"><thead><tr><th width="5%">ที่</th><th width="15%">รหัส</th><th width="30%">ชื่อวิชา</th><th width="10%">ชั้น</th><th width="10%">ห้อง</th><th width="15%">ชม./สัปดาห์</th><th width="10%">พิเศษ</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody><tfoot><tr class="bg-slate-50 font-bold"><td colspan="3">รวม</td><td id="t2-sum-grade">-</td><td id="t2-sum-room">0</td><td id="t2-sum-hour">0</td><td id="t2-sum-special">0</td><td class="no-print"></td></tr></tfoot></table></div>
                    <button onclick="addTeachRow('teach-t2')" class="btn-add no-print">+ เพิ่มวิชา</button>
                </div>
            </div>

            <div class="k-card avoid-break">
                <h3 class="font-bold text-rose-600 mb-4 text-lg">2.2 ปฏิบัติการสอนแทน</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div><label class="k-label">ภาคเรียนที่ 1 (คาบ)</label><input type="number" id="sub-teach-t1" class="k-input"></div>
                    <div><label class="k-label">ภาคเรียนที่ 2 (คาบ)</label><input type="number" id="sub-teach-t2" class="k-input"></div>
                </div>
            </div>

            <div class="k-card">
                <h3 class="font-bold text-rose-600 mb-4 text-lg">2.3 กิจกรรมพัฒนาผู้เรียน</h3>
                <div class="space-y-6">
                    <div class="avoid-break"><h4 class="text-xs font-bold mb-2">ภาคเรียนที่ 1</h4><div class="table-responsive"><table id="dev-act-t1"><thead><tr><th>ลำดับ</th><th>กิจกรรม</th><th>ชั้น</th><th>นร.</th><th>ผ่าน</th><th>ไม่ผ่าน</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addDevActRow('dev-act-t1')" class="btn-add no-print">+ เพิ่ม</button></div>
                    <div class="avoid-break"><h4 class="text-xs font-bold mb-2">ภาคเรียนที่ 2</h4><div class="table-responsive"><table id="dev-act-t2"><thead><tr><th>ลำดับ</th><th>กิจกรรม</th><th>ชั้น</th><th>นร.</th><th>ผ่าน</th><th>ไม่ผ่าน</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addDevActRow('dev-act-t2')" class="btn-add no-print">+ เพิ่ม</button></div>
                </div>
            </div>

            <div class="k-card avoid-break">
                <h3 class="font-bold text-rose-600 mb-4 text-lg">2.4 ครูที่ปรึกษา</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><h4 class="font-bold mb-3 text-rose-800">ภาคเรียนที่ 1</h4><div class="grid grid-cols-2 gap-2"><div class="col-span-2"><label class="k-label">ชั้น/ห้อง</label><input type="text" id="adv-room-t1" class="k-input"></div><div><label class="k-label">ชาย</label><input type="number" id="adv-m-t1" class="k-input advisory-t1" oninput="sumAdvisory(1)"></div><div><label class="k-label">หญิง</label><input type="number" id="adv-f-t1" class="k-input advisory-t1" oninput="sumAdvisory(1)"></div><div class="col-span-2"><label class="k-label">รวม</label><input type="text" id="adv-sum-t1" class="k-input bg-white font-bold" readonly></div></div></div>
                    <div class="p-4 bg-slate-50 rounded-lg border border-slate-100"><h4 class="font-bold mb-3 text-rose-800">ภาคเรียนที่ 2</h4><div class="grid grid-cols-2 gap-2"><div class="col-span-2"><label class="k-label">ชั้น/ห้อง</label><input type="text" id="adv-room-t2" class="k-input"></div><div><label class="k-label">ชาย</label><input type="number" id="adv-m-t2" class="k-input advisory-t2" oninput="sumAdvisory(2)"></div><div><label class="k-label">หญิง</label><input type="number" id="adv-f-t2" class="k-input advisory-t2" oninput="sumAdvisory(2)"></div><div class="col-span-2"><label class="k-label">รวม</label><input type="text" id="adv-sum-t2" class="k-input bg-white font-bold" readonly></div></div></div>
                </div>
            </div>

            <div class="k-card avoid-break">
                <h3 class="font-bold text-rose-600 mb-4 text-lg">2.5 งานพิเศษ</h3>
                <div class="table-responsive"><table id="special-task"><thead><tr><th width="5%">ที่</th><th width="30%">กลุ่มงาน</th><th width="45%">งานที่ได้รับมอบหมาย</th><th width="15%">ชม./สัปดาห์</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div>
                <button onclick="addRow('special-task')" class="btn-add no-print">+ เพิ่มงาน</button>
            </div>
        </div>

        <div id="section-3" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">3</div><h2 class="text-2xl font-black text-rose-700">การพัฒนาการสอน</h2>
            </div>
            <div class="k-card avoid-break"><h3 class="font-bold text-rose-600 mb-4">3.1 จัดทำแผนการเรียนรู้</h3><div class="table-responsive"><table id="plan-table"><thead><tr><th width="5%">ที่</th><th>รหัส</th><th>รายวิชา</th><th>ชั้น</th><th>แผน</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addRow('plan-table')" class="btn-add no-print">+ เพิ่ม</button></div>
            <div class="k-card avoid-break"><h3 class="font-bold text-rose-600 mb-4">3.2 ผลิตสื่อ / นวัตกรรม</h3><div class="table-responsive"><table id="media-table-new"><thead><tr><th width="5%">ที่</th><th>สื่อ/นวัตกรรม</th><th>รายวิชา</th><th>จำนวน</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addRow('media-table-new')" class="btn-add no-print">+ เพิ่ม</button></div>
            <div class="k-card avoid-break">
                <h3 class="font-bold text-rose-600 mb-4">3.3 บูรณาการ / วิจัย</h3>
                <div class="flex flex-col gap-6">
                    <div class="avoid-break"><h4 class="text-xs font-bold mb-2">แผนบูรณาการ</h4><div class="table-responsive"><table id="inter-table"><thead><tr><th width="5%">ที่</th><th width="70%">เรื่อง</th><th width="20%">ชม.</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addRow('inter-table')" class="btn-add no-print">+ เพิ่ม</button></div>
                    <div class="avoid-break"><h4 class="text-xs font-bold mb-2">วิจัยในชั้นเรียน</h4><div class="table-responsive"><table id="res-table"><thead><tr><th width="5%">ที่</th><th>เรื่อง</th><th>วิชา/ชั้น</th><th class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addRow('res-table')" class="btn-add no-print">+ เพิ่ม</button></div>
                </div>
            </div>
            <div class="k-card avoid-break"><h3 class="font-bold text-rose-600 mb-4">3.4 รูปแบบการสอน</h3><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-2 mb-6" id="teaching-methods"></div><div class="summary-box">สรุป: <span id="method-count" class="text-rose-600 text-xl font-black">0</span> วิธี</div></div>
            <div class="k-card avoid-break"><h3 class="font-bold text-rose-600 mb-4">3.5 แหล่งเรียนรู้</h3><div class="table-responsive"><table id="learning-resources-table"><thead><tr><th width="5%">ที่</th><th width="45%">แหล่งเรียนรู้</th><th width="15%">ครั้ง</th><th width="35%">ผลการใช้</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div><button onclick="addResourceRow('learning-resources-table')" class="btn-add no-print">+ เพิ่ม</button></div>
        </div>

        <div id="section-4" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">4</div><h2 class="text-2xl font-black text-rose-700">การพัฒนาตนเอง</h2>
            </div>
            <div class="k-card">
                <h3 class="font-bold text-rose-600 mb-4">การพัฒนาตนเอง (อบรม / สัมมนา)</h3>
                <div class="table-responsive"><table id="self-dev-table"><thead><tr><th width="5%">ที่</th><th width="12%">วัน/เดือน/ปี</th><th width="28%">หัวข้อ</th><th width="15%">หน่วยงาน</th><th width="10%">ชม.</th><th width="25%">หลักฐาน</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div>
                <button onclick="addRow('self-dev-table')" class="btn-add no-print">+ เพิ่ม</button>
                <div class="summary-box grid grid-cols-1 md:grid-cols-2 gap-4 text-center"><div>จำนวนครั้ง: <span id="dev-count" class="text-rose-600 font-black">0</span> ครั้ง</div><div>รวม: <span id="dev-hours-sum" class="text-rose-600 font-black">0</span> ชั่วโมง</div></div>
            </div>
        </div>

        <div id="section-5" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">5</div><h2 class="text-2xl font-black text-rose-700">ผลงานภาคภูมิใจ</h2>
            </div>
            <div class="k-card avoid-break">
                <h3 class="font-bold text-rose-600 mb-4">5.1 ผลงานนักเรียน</h3>
                <div class="table-responsive"><table id="student-award-table"><thead><tr><th width="5%">ที่</th><th width="25%">ชื่อนักเรียน</th><th width="10%">ระดับ</th><th width="20%">รางวัล</th><th width="15%">หน่วยงาน</th><th width="20%">รูปภาพ</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div>
                <button onclick="addRow('student-award-table')" class="btn-add no-print">+ เพิ่ม</button>
            </div>
            <div class="k-card avoid-break mt-6">
                <h3 class="font-bold text-rose-600 mb-4">5.2 ผลงานครู</h3>
                <div class="table-responsive"><table id="teacher-award-table"><thead><tr><th width="5%">ที่</th><th width="15%">ระดับ</th><th width="35%">รางวัล</th><th width="20%">หน่วยงาน</th><th width="20%">รูปภาพ</th><th width="5%" class="no-print"></th></tr></thead><tbody></tbody></table></div>
                <button onclick="addRow('teacher-award-table')" class="btn-add no-print">+ เพิ่ม</button>
            </div>
        </div>

        <div id="section-6" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">6</div><h2 class="text-2xl font-black text-rose-700">ผลการปฏิบัติงาน</h2>
            </div>
            <div class="k-card">
                <div class="avoid-break"><h3 class="font-black text-rose-600 mb-4">6.1 ผลสัมฤทธิ์ทางการเรียน</h3>
                <!-- Group Term 1 -->
                <div class="avoid-break mb-8 p-4 bg-slate-50 rounded-xl border border-slate-100"><h4 class="font-bold text-rose-700 mb-3">ภาคเรียนที่ 1</h4><div class="table-responsive"><table id="achieve-t1"><thead><tr><th rowspan="2" width="12%">วิชา</th><th rowspan="2" width="6%">ห้อง</th><th rowspan="2" width="6%">นร.</th><th colspan="10">ระดับผลการเรียน</th><th rowspan="2" width="6%">>=2</th><th rowspan="2" width="6%">>=3</th><th rowspan="2" class="no-print" width="4%"></th></tr><tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr></thead><tbody></tbody></table></div><button onclick="addAchieveRow('achieve-t1')" class="btn-add no-print">+ เพิ่ม</button><div id="detailed-sum-achieve-t1" class="mt-4"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="summary-box flex flex-col gap-2 p-3"><div id="sum-achieve-t1">รอข้อมูล...</div><div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-achieve-t1" value="70" class="w-16 p-1 border rounded text-center no-print text-sm bg-yellow-50 font-bold text-slate-700" oninput="calcAchieveSummary('achieve-t1')"><span id="res-achieve-t1" class="badge"></span></div></div><div class="h-48 bg-white p-2 rounded-lg"><canvas id="chart-t1"></canvas></div></div></div></div>
                <!-- Group Term 2 -->
                <div class="avoid-break p-4 bg-slate-50 rounded-xl border border-slate-100"><h4 class="font-bold text-rose-700 mb-3">ภาคเรียนที่ 2</h4><div class="table-responsive"><table id="achieve-t2"><thead><tr><th rowspan="2" width="12%">วิชา</th><th rowspan="2" width="6%">ห้อง</th><th rowspan="2" width="6%">นร.</th><th colspan="10">ระดับผลการเรียน</th><th rowspan="2" width="6%">>=2</th><th rowspan="2" width="6%">>=3</th><th rowspan="2" class="no-print" width="4%"></th></tr><tr><th>4</th><th>3.5</th><th>3</th><th>2.5</th><th>2</th><th>1.5</th><th>1</th><th>0</th><th>ร</th><th>มส</th></tr></thead><tbody></tbody></table></div><button onclick="addAchieveRow('achieve-t2')" class="btn-add no-print">+ เพิ่ม</button><div id="detailed-sum-achieve-t2" class="mt-4"></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4"><div class="summary-box flex flex-col gap-2 p-3"><div id="sum-achieve-t2">รอข้อมูล...</div><div class="flex items-center gap-2 mt-2 pt-2 border-t border-slate-200"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-achieve-t2" value="70" class="w-16 p-1 border rounded text-center no-print text-sm bg-yellow-50 font-bold text-slate-700" oninput="calcAchieveSummary('achieve-t2')"><span id="res-achieve-t2" class="badge"></span></div></div><div class="h-48 bg-white p-2 rounded-lg"><canvas id="chart-t2"></canvas></div></div></div>
            </div>
            
            <div class="flex flex-col gap-6 mt-6">
                <div class="k-card w-full avoid-break">
                    <h3 class="font-bold text-rose-600 mb-4">6.2 คุณลักษณะอันพึงประสงค์</h3>
                    <div class="avoid-break p-4 bg-slate-50 rounded-xl border border-slate-100 w-full mb-4">
                        <h4 class="text-sm font-bold text-rose-700 mb-2">ภาคเรียนที่ 1</h4>
                        <div class="table-responsive"><table id="attr-t1" class="w-full"><thead><tr><th width="30%">วิชา</th><th width="10%">นร.</th><th>3</th><th>2</th><th>1</th><th>0</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody></table></div>
                        <button onclick="addEvalRow('attr-t1')" class="btn-add no-print">+ เพิ่ม</button>
                        <div id="summary-attr-t1" class="mt-4"></div>
                        <div class="flex items-center gap-2 mt-2 p-2 bg-rose-50 rounded"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-attr-t1" value="80" class="w-16 p-1 border rounded text-center text-sm font-bold text-slate-700" oninput="calcEvalTable('attr-t1')"></div>
                    </div>
                    <div class="avoid-break p-4 bg-slate-50 rounded-xl border border-slate-100 w-full">
                        <h4 class="text-sm font-bold text-rose-700 mb-2">ภาคเรียนที่ 2</h4>
                        <div class="table-responsive"><table id="attr-t2" class="w-full"><thead><tr><th width="30%">วิชา</th><th width="10%">นร.</th><th>3</th><th>2</th><th>1</th><th>0</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody></table></div>
                        <button onclick="addEvalRow('attr-t2')" class="btn-add no-print">+ เพิ่ม</button>
                        <div id="summary-attr-t2" class="mt-4"></div>
                        <div class="flex items-center gap-2 mt-2 p-2 bg-rose-50 rounded"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-attr-t2" value="80" class="w-16 p-1 border rounded text-center text-sm font-bold text-slate-700" oninput="calcEvalTable('attr-t2')"></div>
                    </div>
                </div>
                <div class="k-card w-full avoid-break">
                    <h3 class="font-bold text-rose-600 mb-4">6.3 การอ่าน คิดวิเคราะห์ และเขียน</h3>
                    <div class="avoid-break p-4 bg-slate-50 rounded-xl border border-slate-100 w-full mb-4">
                        <h4 class="text-sm font-bold text-rose-700 mb-2">ภาคเรียนที่ 1</h4>
                        <div class="table-responsive"><table id="read-t1" class="w-full"><thead><tr><th width="30%">วิชา</th><th width="10%">นร.</th><th>3</th><th>2</th><th>1</th><th>0</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody></table></div>
                        <button onclick="addEvalRow('read-t1')" class="btn-add no-print">+ เพิ่ม</button>
                        <div id="summary-read-t1" class="mt-4"></div>
                        <div class="flex items-center gap-2 mt-2 p-2 bg-rose-50 rounded"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-read-t1" value="80" class="w-16 p-1 border rounded text-center text-sm font-bold text-slate-700" oninput="calcEvalTable('read-t1')"></div>
                    </div>
                    <div class="avoid-break p-4 bg-slate-50 rounded-xl border border-slate-100 w-full">
                        <h4 class="text-sm font-bold text-rose-700 mb-2">ภาคเรียนที่ 2</h4>
                        <div class="table-responsive"><table id="read-t2" class="w-full"><thead><tr><th width="30%">วิชา</th><th width="10%">นร.</th><th>3</th><th>2</th><th>1</th><th>0</th><th class="no-print" width="5%"></th></tr></thead><tbody></tbody></table></div>
                        <button onclick="addEvalRow('read-t2')" class="btn-add no-print">+ เพิ่ม</button>
                        <div id="summary-read-t2" class="mt-4"></div>
                        <div class="flex items-center gap-2 mt-2 p-2 bg-rose-50 rounded"><span class="text-xs font-bold text-slate-600">เป้าหมาย (%):</span><input type="number" id="target-read-t2" value="80" class="w-16 p-1 border rounded text-center text-sm font-bold text-slate-700" oninput="calcEvalTable('read-t2')"></div>
                    </div>
                </div>
            </div>
            
            <div class="k-card mt-6 avoid-break">
                <h3 class="font-bold text-rose-600 mb-4 flex items-center gap-2"><i class="ph ph-files"></i> แหล่งข้อมูล/หลักฐาน</h3>
                <textarea id="section-6-evidence" class="k-input w-full p-4 h-32 rounded-lg border-slate-200" placeholder="- แบบบันทึกผลการเรียน (ปพ.5)&#10;- ชิ้นงาน/ผลงานนักเรียน..."></textarea>
            </div>
        </div>

        <div id="section-7" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">7</div><h2 class="text-2xl font-black text-rose-700">ผลการประเมินแผน</h2>
            </div>
            <div class="k-card">
                <div id="plan-evaluation-logic" class="space-y-6"></div>
                <div class="summary-box mt-8 flex justify-between items-center text-lg p-6 bg-rose-50 border-rose-200 rounded-2xl"><div>คะแนนรวม: <span id="plan-score" class="text-rose-600 font-black">0</span> / 20</div><div>ระดับคุณภาพ: <span id="plan-quality" class="text-rose-600 font-black">-</span></div></div>
            </div>
        </div>

        <div id="section-8" class="tab-content hidden section-break">
            <div class="section-header flex items-center gap-3 mb-6 pb-2 border-b-4 border-rose-100 pt-6">
                <div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600 font-bold text-lg">8</div><h2 class="text-2xl font-black text-rose-700">มาตรฐานการศึกษา</h2>
            </div>
             <div class="k-card">
                <div class="table-responsive"><table id="std-table"><thead><tr><th width="75%" class="text-left px-4">ตัวบ่งชี้</th><th width="25%">ระดับคุณภาพ (5-1)</th></tr></thead><tbody id="std-body"></tbody></table></div>
                <div class="summary-box mt-6 p-6 grid grid-cols-1 md:grid-cols-3 gap-6 text-center"><div class="border-b md:border-b-0 md:border-r border-slate-200">มาตรฐานที่ 1: <br><span id="std-res-1" class="font-bold text-rose-600">-</span></div><div class="border-b md:border-b-0 md:border-r border-slate-200">มาตรฐานที่ 2: <br><span id="std-res-2" class="font-bold text-rose-600">-</span></div><div>มาตรฐานที่ 3: <br><span id="std-res-3" class="font-bold text-rose-600">-</span></div></div>
            </div>
            <div id="std-qualitative-container" class="mt-6"></div>
            <div id="signature-section" class="mt-10 text-center flex flex-col items-center">
                <div class="mb-6"><div class="text-center mb-2 font-bold text-slate-500">ลงชื่อผู้รายงาน</div><div id="sig-preview" class="mb-4 bg-white border border-slate-300"><span class="text-slate-300 text-xs p-4 block">ยังไม่มีลายเซ็น</span></div><input type="file" id="sig-input" accept="image/*" class="hidden" onchange="previewSignature(this)"><button onclick="document.getElementById('sig-input').click()" class="no-print text-xs font-bold text-rose-600 border border-rose-600 px-3 py-2 rounded-md hover:bg-rose-50 transition w-full md:w-auto"><i class="ph ph-pen-nib"></i> อัปโหลดลายเซ็น</button></div>
                <div class="text-lg font-bold text-slate-800">(<span id="sig-name-display">...</span>)</div><div class="text-slate-600 mt-1">ผู้รายงาน</div>
            </div>
        </div>
    </main>

    <script>
        let SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVO3CiKjjJ6cHnDc_ZFfLhKw0Q3B4xdzSpnf7j2KRksSxSFLvHkXADnLk-kQReceDsiA/exec';
        const TARGET_SHEET_ID = '1hb8D_hp65UPkgdLoxNRP47_e3-t800H7d6vFluk6PRA'; 
        const TARGET_FOLDER_ID = '1LvOEy5SafTskIUwIZnJAweef9Ym2TrLV'; 

        async function saveAndUpload() {
            const name = document.getElementById('t-name').value;
            if(!name) { Swal.fire('แจ้งเตือน', 'กรุณาระบุชื่อ-นามสกุล ก่อนบันทึกข้อมูล', 'warning'); return; }

            document.getElementById('loading-overlay').style.display = 'flex';
            
            try {
                prepareForPDF();
                await new Promise(resolve => setTimeout(resolve, 1500));
                window.scrollTo(0, 0);

                const element = document.getElementById('printable-content');
                
                // FIX #1 & #2 & #5: Balanced margins, optimized windowWidth, simplified fonts
                const opt = { 
                    margin: [10, 10, 10, 10], // Left margin reduced from excessive padding
                    filename: 'SAR.pdf', 
                    image: { type: 'jpeg', quality: 0.98 }, 
                    html2canvas: { 
                        scale: 2, 
                        useCORS: true, 
                        logging: false, 
                        scrollY: 0, 
                        scrollX: 0,
                        windowWidth: 794 // STRICT A4 width @ 96DPI to force layout match
                    }, 
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['css', 'legacy'] }
                };

                let base64Data;
                try {
                     const pdfDataUri = await html2pdf().from(element).set(opt).output('datauristring');
                     base64Data = pdfDataUri.split(',')[1];
                } catch (pdfErr) {
                    console.warn("Retrying PDF generation without logos due to error");
                    const logos = document.querySelectorAll('.school-logo');
                    logos.forEach(img => img.style.display = 'none');
                    try {
                        const pdfDataUriRetry = await html2pdf().from(element).set(opt).output('datauristring');
                        base64Data = pdfDataUriRetry.split(',')[1];
                    } catch (retryErr) { throw new Error("PDF Gen Failed"); }
                }
                
                const formData = collectSARData();
                const payload = {
                    ...formData,
                    sheetId: TARGET_SHEET_ID,
                    sheetName: "SAR", 
                    folderId: TARGET_FOLDER_ID,
                    pdfBase64: base64Data,
                    fileName: `${name}.pdf`,
                    teacherName: name 
                };

                const response = await fetch(SCRIPT_URL, {
                    method: 'POST', redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                
                if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
                const res = await response.json();
                if (res.result === 'error') throw new Error(res.message);

                document.getElementById('loading-overlay').style.display = 'none';
                Swal.fire('สำเร็จ', 'บันทึกข้อมูลเรียบร้อยแล้ว!', 'success');
                
            } catch (error) {
                console.error("Save Error:", error);
                document.getElementById('loading-overlay').style.display = 'none';
                Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: error.message });
            } finally {
                restoreFromPDF();
                document.querySelectorAll('.school-logo').forEach(img => img.style.display = 'block');
            }
        }

        function prepareForPDF() {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('hidden'));
            document.getElementById('cover-name-display').innerText = document.getElementById('t-name').value;
            document.getElementById('cover-year-display').innerText = document.getElementById('input-year').value;
            document.getElementById('sig-name-display').innerText = document.getElementById('t-name').value;
            
            const photoSrc = document.querySelector('#photo-preview img')?.src;
            const coverPhotoContainer = document.getElementById('cover-photo-container');
            coverPhotoContainer.innerHTML = photoSrc ? `<img src="${photoSrc}" style="width:100%; height:100%; object-fit:cover;">` : `<span class="text-slate-300 text-xs">ไม่มีรูป</span>`;
            document.body.classList.add('pdf-mode');

            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type === 'file' || el.type === 'checkbox' || el.type === 'hidden') return;
                if (el.id === 'birthdate' || el.id === 'workdate') return; 

                const val = el.value || (el.options && el.selectedIndex >= 0 ? el.options[el.selectedIndex].text : '') || '-';
                const span = document.createElement('div');
                span.className = 'pdf-text-val';
                span.textContent = val;
                el.parentNode.insertBefore(span, el);
            });
        }

        function restoreFromPDF() {
            document.body.classList.remove('pdf-mode');
            document.querySelectorAll('.pdf-text-val').forEach(el => el.remove());
            showTab(1); 
        }

        const getRowFilesData = (row) => {
             const images = row.querySelectorAll('.table-img-preview');
             const files = [];
             images.forEach(img => { if(img.dataset.base64) files.push({ data: img.dataset.base64, mime: img.dataset.mime }); });
             return files;
        };

        function collectSARData() {
            const name = document.getElementById('t-name').value || "Teacher";
            
            const getTableDataWithIndex = (tableId, colIndex) => {
                const rows = Array.from(document.querySelectorAll(`#${tableId} tbody tr`));
                return rows.map((r, i) => {
                    const inputs = Array.from(r.querySelectorAll('input:not([type=file]), textarea, select'));
                    const val = inputs[colIndex] ? inputs[colIndex].value : "-";
                    return `${i+1}. ${val}`; 
                }).join('\n');
            };

            const getTableDataWithFiles = (tableId, typeSuffix) => {
                const rows = Array.from(document.querySelectorAll(`#${tableId} tbody tr`));
                return rows.map((r, rowIndex) => {
                    const rowData = Array.from(r.querySelectorAll('input:not([type=file]), textarea, select')).map(i => i.value);
                    const filesData = getRowFilesData(r);
                    let filePayloads = [];
                    if(filesData.length > 0) {
                        filesData.forEach((file, fileIndex) => {
                            const ext = file.mime.split('/')[1];
                            filePayloads.push({ name: `${name}_${typeSuffix}_ลำดับที่${rowIndex+1}_รูปที่${fileIndex+1}.${ext}`, data: file.data, mime: file.mime });
                        });
                    }
                    return { data: rowData, files: filePayloads };
                });
            };

            const selfDevData = getTableDataWithFiles('self-dev-table', 'การอบรม');
            const studentAwardData = getTableDataWithFiles('student-award-table', 'ผลงานนักเรียน');
            const teacherAwardData = getTableDataWithFiles('teacher-award-table', 'ผลงานครู');
            
            const allFiles = [...selfDevData.flatMap(i => i.files), ...studentAwardData.flatMap(i => i.files), ...teacherAwardData.flatMap(i => i.files)];

            const getStdData = (id) => {
                const el = document.getElementById(`std-res-${id}`);
                if (!el) return { score: '-', res: '-' };
                const parts = el.innerHTML.split('<br>');
                return { score: parts[0]?.replace(/<[^>]*>/g, '').trim() || '-', res: parts[1]?.replace(/<[^>]*>/g, '').replace(/[()]/g, '').trim() || '-' };
            };

            const std1 = getStdData(1); const std2 = getStdData(2); const std3 = getStdData(3);
            const planScore = parseInt(document.getElementById('plan-score').innerText) || 0;
            let planRes = "-"; if(planScore >= 18) planRes = "ดีมาก"; else if(planScore >= 14) planRes = "ดี"; else if(planScore >= 10) planRes = "พอใช้"; else planRes = "ปรับปรุง";

            return {
                "เวลาบันทึก": new Date().toLocaleString('th-TH'),
                "ชื่อ-นามสกุล": document.getElementById('t-name').value,
                "ปีการศึกษา": document.getElementById('input-year').value,
                "ตำแหน่ง": document.getElementById('t-position').value,
                "วิทยฐานะ": document.getElementById('t-academic').value,
                "กลุ่มสาระ": document.getElementById('t-group').value,
                "ร่องรอยและหลักฐานผลการปฎิบัติงาน": document.getElementById('section-6-evidence').value,
                "คะแนนประเมินแผน": document.getElementById('plan-score').innerText,
                "ผลการประเมินแผน": planRes,
                "คะแนนมาตรฐานที่ 1": std1.score, "ผลการประเมินมาตรฐานที่ 1": std1.res,
                "คะแนนมาตรฐานที่ 2": std2.score, "ผลการประเมินมาตรฐานที่ 2": std2.res,
                "คะแนนมาตรฐานที่ 3": std3.score, "ผลการประเมินมาตรฐานที่ 3": std3.res,
                "กระบวนการพัฒนามาตรฐานที่ 1": document.getElementById('std1-process')?.value || '',
                "ผลการพัฒนามาตรฐานที่ 1": document.getElementById('std1-result')?.value || '',
                "จุดเด่นมาตรฐานที่ 1": document.getElementById('std1-strength')?.value || '',
                "จุดที่ควรพัฒนามาตรฐานที่ 1": document.getElementById('std1-improvement')?.value || '',
                "กระบวนการพัฒนามาตรฐานที่ 2": document.getElementById('std2-process')?.value || '',
                "ผลการพัฒนามาตรฐานที่ 2": document.getElementById('std2-result')?.value || '',
                "จุดเด่นมาตรฐานที่ 2": document.getElementById('std2-strength')?.value || '',
                "จุดที่ควรพัฒนามาตรฐานที่ 2": document.getElementById('std2-improvement')?.value || '',
                "กระบวนการพัฒนามาตรฐานที่ 3": document.getElementById('std3-process')?.value || '',
                "ผลการพัฒนามาตรฐานที่ 3": document.getElementById('std3-result')?.value || '',
                "จุดเด่นมาตรฐานที่ 3": document.getElementById('std3-strength')?.value || '',
                "จุดที่ควรพัฒนามาตรฐานที่ 3": document.getElementById('std3-improvement')?.value || '',

                "ชื่อนักเรียน": getTableDataWithIndex('student-award-table', 0),
                "ระดับรางวัลนักเรียน": getTableDataWithIndex('student-award-table', 1),
                "รางวัลที่ได้รับของนักเรียน": getTableDataWithIndex('student-award-table', 2),
                "หน่วยงานที่มอบของนักเรียน": getTableDataWithIndex('student-award-table', 3),

                "ระดับรางวัลครู": getTableDataWithIndex('teacher-award-table', 0),
                "รางวัลที่ได้รับของครู": getTableDataWithIndex('teacher-award-table', 1),
                "หน่วยงานที่มอบของครู": getTableDataWithIndex('teacher-award-table', 2),

                "ลิงก์ไฟล์ PDF (Drive)": "", 
                files_to_save: allFiles
            };
        }

        function showTab(n) { document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden')); document.querySelectorAll('.sidebar-item').forEach(el => el.classList.remove('active')); document.getElementById('section-' + n).classList.remove('hidden'); document.getElementById('tab-' + n).classList.add('active'); window.scrollTo(0,0); }
        function previewImage(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('photo-preview').innerHTML = `<img src="${e.target.result}">`; }; reader.readAsDataURL(input.files[0]); } }
        function previewSignature(input) { if (input.files && input.files[0]) { const reader = new FileReader(); reader.onload = e => { document.getElementById('sig-preview').innerHTML = `<img src="${e.target.result}">`; }; reader.readAsDataURL(input.files[0]); } }
        function handleTableFile(input) { if (input.files && input.files[0]) { const file = input.files[0]; const reader = new FileReader(); reader.onload = function(e) { const wrapper = document.createElement('div'); wrapper.className = 'img-wrapper'; const img = document.createElement('img'); img.src = e.target.result; img.className = 'table-img-preview'; img.dataset.base64 = e.target.result.split(',')[1]; img.dataset.mime = file.type; const removeBtn = document.createElement('div'); removeBtn.className = 'remove-img-btn no-print'; removeBtn.innerHTML = '✕'; removeBtn.onclick = function() { wrapper.remove(); }; wrapper.appendChild(img); wrapper.appendChild(removeBtn); const previewDiv = input.closest('td').querySelector('.table-img-preview-container'); if(previewDiv) { previewDiv.appendChild(wrapper); } input.value = ''; }; reader.readAsDataURL(file); } }
        
        function autoResize(textarea) { textarea.style.height = 'auto'; textarea.style.height = textarea.scrollHeight + 'px'; }
        
        function reIndex(tableId) { 
            const table = document.getElementById(tableId);
            if (!table) return;
            const rows = table.querySelectorAll('tbody tr'); 
            rows.forEach((row, i) => { 
                const idxCell = row.querySelector('.row-num'); 
                if(idxCell) idxCell.setAttribute('data-index', i + 1); 
            }); 
            if(tableId === 'self-dev-table') { 
                const devCount = document.getElementById('dev-count');
                if(devCount) devCount.innerText = rows.length; 
                calcDevHours(); 
            } 
        }
        
        const createCell = (placeholder) => `<td><textarea class="k-input" placeholder="${placeholder}" oninput="autoResize(this)"></textarea></td>`;
        const createFileCell = () => `<td class="text-center align-top"><label class="table-upload-btn no-print"><i class="ph ph-plus"></i> <span>เพิ่มรูป</span><input type="file" accept="image/*" class="hidden table-file-input" onchange="handleTableFile(this)"></label><div class="table-img-preview-container"></div></td>`;
        const levelOptions = `<option value="ระดับชาติ">ระดับชาติ</option><option value="ระดับภาค">ระดับภาค</option><option value="ระดับจังหวัด/เขตพื้นที่การศึกษา">ระดับจังหวัด/เขตฯ</option>`; 

        function addRow(tableId) { 
            const tbody = document.getElementById(tableId).querySelector('tbody'); 
            const row = tbody.insertRow(); 
            let html = `<td class="row-num font-bold text-slate-400"></td>`; 
            if(tableId === 'edu-table') html += createCell('วุฒิการศึกษา') + createCell('วิชาเอก') + createCell('สถาบัน'); 
            else if(tableId === 'special-task') html += createCell('กลุ่มงาน') + createCell('งานที่มอบหมาย') + `<td><input type="number" class="k-input text-center" placeholder="0"></td>`; 
            else if(tableId === 'plan-table') html += createCell('รหัสวิชา') + createCell('ชื่อวิชา') + createCell('ชั้น') + `<td><input type="number" class="k-input text-center" placeholder="0"></td>`; 
            else if(tableId === 'media-table-new') html += createCell('ชื่อสื่อ') + createCell('วิชา') + `<td><input type="number" class="k-input text-center" placeholder="0"></td>`; 
            else if(tableId === 'inter-table') html += createCell('เรื่อง') + `<td><input type="number" class="k-input text-center" placeholder="0"></td>`; 
            else if(tableId === 'res-table') html += createCell('เรื่อง') + createCell('รายวิชา/ชั้น'); 
            else if(tableId === 'self-dev-table') { html += `<td><input type="date" class="k-input"></td>` + createCell('หัวข้ออบรม') + createCell('หน่วยงาน') + `<td><input type="number" class="k-input dev-hr" oninput="calcDevHours()"></td>` + createFileCell(); } 
            else if(tableId === 'student-award-table') { html += createCell('ชื่อนักเรียน') + `<td><select class="k-input">${levelOptions}</select></td>` + createCell('รางวัลที่ได้รับ') + createCell('หน่วยงานที่มอบ') + createFileCell(); } 
            else if(tableId === 'teacher-award-table') { html += `<td><select class="k-input">${levelOptions}</select></td>` + createCell('รางวัลที่ได้รับ') + createCell('หน่วยงานที่มอบ') + createFileCell(); } 
            row.innerHTML = html + `<td class="no-print"><button onclick="this.closest('tr').remove(); reIndex('${tableId}')" class="text-rose-300 hover:text-rose-600">✕</button></td>`; 
            reIndex(tableId); 
        }

        function addResourceRow(tableId) { const tbody = document.getElementById(tableId).querySelector('tbody'); const row = tbody.insertRow(); row.innerHTML = `<td class="row-num font-bold text-slate-400"></td><td><textarea class="k-input" placeholder="ชื่อแหล่งเรียนรู้" oninput="autoResize(this)"></textarea></td><td><input type="number" class="k-input text-center" placeholder="0"></td><td><textarea class="k-input" placeholder="ผลการใช้" oninput="autoResize(this)"></textarea></td><td class="no-print"><button onclick="this.closest('tr').remove(); reIndex('${tableId}')" class="text-rose-300 hover:text-rose-600">✕</button></td>`; reIndex(tableId); }
        function addTeachRow(tableId) { const tbody = document.getElementById(tableId).querySelector('tbody'); const row = tbody.insertRow(); row.innerHTML = `<td class="row-num text-[10px]"></td><td><textarea class="k-input p-1" oninput="autoResize(this)"></textarea></td><td><textarea class="k-input p-1" oninput="autoResize(this)"></textarea></td><td><input type="text" class="k-input p-1 text-center grade-in" oninput="sumTeach('${tableId}')"></td><td><input type="number" class="k-input p-1 text-center room-in" oninput="sumTeach('${tableId}')"></td><td><input type="number" class="k-input p-1 text-center hour-in" oninput="sumTeach('${tableId}')"></td><td><input type="number" class="k-input p-1 text-center spec-in" oninput="sumTeach('${tableId}')"></td><td class="no-print"><button onclick="this.closest('tr').remove(); sumTeach('${tableId}'); reIndex('${tableId}')" class="text-rose-300">✕</button></td>`; reIndex(tableId); }
        function calcDevHours() { let sum = 0; document.querySelectorAll('.dev-hr').forEach(i => sum += (parseFloat(i.value) || 0)); const sumEl = document.getElementById('dev-hours-sum'); if(sumEl) sumEl.innerText = sum; }
        function sumTeach(tableId) { const rows = document.getElementById(tableId).querySelectorAll('tbody tr'); let room = 0, hour = 0, spec = 0; const grades = []; rows.forEach(r => { const g = r.querySelector('.grade-in').value; if(g) grades.push(g); room += parseInt(r.querySelector('.room-in').value) || 0; hour += parseFloat(r.querySelector('.hour-in').value) || 0; spec += parseInt(r.querySelector('.spec-in').value) || 0; }); const term = tableId.split('-')[1]; document.getElementById(`${term}-sum-grade`).innerText = [...new Set(grades)].join(', ') || '-'; document.getElementById(`${term}-sum-room`).innerText = room; document.getElementById(`${term}-sum-hour`).innerText = hour; document.getElementById(`${term}-sum-special`).innerText = spec; }
        function addDevActRow(tableId) { const tbody = document.getElementById(tableId).querySelector('tbody'); const row = tbody.insertRow(); row.innerHTML = `<td class="row-num"></td><td><textarea class="k-input" oninput="autoResize(this)"></textarea></td><td><input type="text" class="k-input"></td><td><input type="number" class="k-input"></td><td><input type="number" class="k-input"></td><td><input type="number" class="k-input"></td><td class="no-print"><button onclick="this.closest('tr').remove(); reIndex('${tableId}')" class="text-rose-300">✕</button></td>`; reIndex(tableId); }
        function sumAdvisory(term) { const inputs = document.querySelectorAll(`.advisory-t${term}`); let sum = 0; inputs.forEach(i => sum += (parseInt(i.value) || 0)); document.getElementById(`adv-sum-t${term}`).value = sum + " คน"; }
        
        /* Auto Calc Age & Date Format */
        function calcAge(dateId, resId, displayId) {
            const dateVal = document.getElementById(dateId).value;
            if (!dateVal) return;
            const date = new Date(dateVal);
            const now = new Date();
            
            // Age Calc
            let years = now.getFullYear() - date.getFullYear();
            let months = now.getMonth() - date.getMonth();
            if (months < 0 || (months === 0 && now.getDate() < date.getDate())) {
                years--;
                months += 12;
            }
            if (now.getDate() < date.getDate()) months--;
            document.getElementById(resId).value = `${years} ปี ${months} เดือน`;
            
            // Thai Date Display
            const thaiMonths = ["มกราคม", "กุมภาพันธ์", "มีนาคม", "เมษายน", "พฤษภาคม", "มิถุนายน", "กรกฎาคม", "สิงหาคม", "กันยายน", "ตุลาคม", "พฤศจิกายน", "ธันวาคม"];
            const d = date.getDate();
            const m = thaiMonths[date.getMonth()];
            const y = date.getFullYear() + 543;
            document.getElementById(displayId).innerText = `${d} ${m} พ.ศ. ${y}`;
        }

        // Charts & Eval
        let charts = {};
        function updateChart(term) { const canvas = document.getElementById('chart-t'+term); if(!canvas) return; const ctx = canvas.getContext('2d'); const data = Array(8).fill(0); document.getElementById('achieve-t'+term).querySelectorAll('tbody tr').forEach(r => { const ins = r.querySelectorAll('.g-input'); for(let i=0; i<8; i++) data[i] += (parseInt(ins[i].value) || 0); }); if(charts[term]) charts[term].destroy(); charts[term] = new Chart(ctx, { type: 'bar', data: { labels: ['4','3.5','3','2.5','2','1.5','1','0'], datasets: [{ data: data, backgroundColor: '#e11d48', borderRadius: 4 }] }, options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } } }); }
        function addAchieveRow(tableId) { const tbody = document.getElementById(tableId).querySelector('tbody'); const row = tbody.insertRow(); row.innerHTML = `<td><textarea class="k-input p-1 text-xs" oninput="autoResize(this)"></textarea></td><td><input type="text" class="k-input p-1 text-center text-xs"></td><td><input type="number" class="k-input p-1 text-center g-total bg-slate-50" readonly placeholder="รวม"></td>${Array(10).fill(0).map(() => `<td><input type="number" class="k-input p-1 text-center g-input" oninput="calcAchieveRow('${tableId}', this)"></td>`).join('')}<td class="bg-blue-50 font-bold g-res-2 text-[10px] text-center align-middle">-</td><td class="bg-green-50 font-bold g-res-3 text-[10px] text-center align-middle">-</td><td class="no-print"><button onclick="this.closest('tr').remove(); calcAchieveSummary('${tableId}'); updateChart(${tableId.slice(-1)})" class="text-rose-300">✕</button></td>`; }
        function calcAchieveRow(tId, inp) { const r = inp.closest('tr'); let calculatedTotal = 0, s2 = 0, s3 = 0; const ins = r.querySelectorAll('.g-input'); ins.forEach((input, index) => { const val = parseInt(input.value) || 0; calculatedTotal += val; if (index < 5) s2 += val; if (index < 3) s3 += val; }); r.querySelector('.g-total').value = calculatedTotal; if(calculatedTotal > 0) { r.querySelector('.g-res-2').innerText = ((s2/calculatedTotal)*100).toFixed(1) + "%"; r.querySelector('.g-res-3').innerText = ((s3/calculatedTotal)*100).toFixed(1) + "%"; } else { r.querySelector('.g-res-2').innerText = "-"; r.querySelector('.g-res-3').innerText = "-"; } calcAchieveSummary(tId); updateChart(tId.slice(-1)); }
        function calcAchieveSummary(tId) { const rows = document.getElementById(tId).querySelectorAll('tbody tr'); let tot = 0, s2 = 0, s3 = 0; let gradeCounts = [0,0,0,0,0,0,0,0,0,0]; rows.forEach(r => { tot += parseInt(r.querySelector('.g-total').value) || 0; const ins = r.querySelectorAll('.g-input'); ins.forEach((input, i) => { const val = parseInt(input.value) || 0; gradeCounts[i] += val; if(i < 5) s2 += val; if(i < 3) s3 += val; }); }); const p2 = tot ? ((s2/tot)*100).toFixed(2) : 0; const p3 = tot ? ((s3/tot)*100).toFixed(2) : 0; document.getElementById('sum-'+tId).innerHTML = `รวม: ${tot} คน | >=2: ${p2}% | >=3: ${p3}%`; const labels = ['4', '3.5', '3', '2.5', '2', '1.5', '1', '0', 'ร', 'มส']; let html = '<table class="mini-summary-table"><thead><tr>' + labels.map(l=>`<th>${l}</th>`).join('') + '</tr></thead><tbody><tr>'; html += labels.map((l, i) => `<td>${gradeCounts[i]}</td>`).join(''); html += '</tr></tbody></table>'; document.getElementById('detailed-sum-' + tId).innerHTML = html; const target = parseFloat(document.getElementById('target-' + tId).value) || 0; const resEl = document.getElementById('res-' + tId); if (parseFloat(p3) >= target) { resEl.innerText = "สูงกว่าเป้าหมาย/ผ่าน"; resEl.className = "badge badge-success"; } else { resEl.innerText = "ต่ำกว่าเป้าหมาย/ไม่ผ่าน"; resEl.className = "badge badge-fail"; } }
        
        function addEvalRow(tId) { const tbody = document.getElementById(tId).querySelector('tbody'); const row = tbody.insertRow(); const type = tId.split('-')[0]; row.innerHTML = `<td><textarea class="k-input p-1" placeholder="ชื่อรายวิชา" oninput="autoResize(this)"></textarea></td><td><input type="number" class="k-input p-1 e-total bg-slate-50 font-bold text-center" readonly tabindex="-1" placeholder="0"></td><td><input type="number" class="k-input p-1 e-3 text-center" oninput="calcEvalRow(this, '${type}', '${tId}')"></td><td><input type="number" class="k-input p-1 e-2 text-center" oninput="calcEvalRow(this, '${type}', '${tId}')"></td><td><input type="number" class="k-input p-1 e-1 text-center" oninput="calcEvalRow(this, '${type}', '${tId}')"></td><td><input type="number" class="k-input p-1 e-0 text-center" oninput="calcEvalRow(this, '${type}', '${tId}')"></td><td class="no-print"><button onclick="this.closest('tr').remove(); calcEvalTable('${tId}')" class="text-rose-300 hover:text-rose-600">✕</button></td>`; }
        function calcEvalRow(input, type, tId) { const row = input.closest('tr'); const v3 = parseInt(row.querySelector('.e-3').value) || 0; const v2 = parseInt(row.querySelector('.e-2').value) || 0; const v1 = parseInt(row.querySelector('.e-1').value) || 0; const v0 = parseInt(row.querySelector('.e-0').value) || 0; row.querySelector('.e-total').value = v3 + v2 + v1 + v0; calcEvalTable(tId); }
        
        /* Updated Eval Table Calculation (With Pass/Fail Logic) */
        function calcEvalTable(tId) { 
            const table = document.getElementById(tId); 
            if(!table) return; 
            let sums = {3:0, 2:0, 1:0, 0:0}; 
            let total = 0; 
            
            table.querySelectorAll('tbody tr').forEach(r => { 
                const v3 = parseInt(r.querySelector('.e-3').value) || 0; 
                const v2 = parseInt(r.querySelector('.e-2').value) || 0; 
                const v1 = parseInt(r.querySelector('.e-1').value) || 0; 
                const v0 = parseInt(r.querySelector('.e-0').value) || 0; 
                sums[3] += v3; sums[2] += v2; sums[1] += v1; sums[0] += v0; 
                total += (v3 + v2 + v1 + v0); 
            }); 
            
            // Pass = Level 2 up (3, 2)
            const passCount = sums[3] + sums[2];
            const failCount = sums[1] + sums[0];
            const passPercent = total ? ((passCount/total)*100).toFixed(2) : 0;
            const failPercent = total ? ((failCount/total)*100).toFixed(2) : 0;
            
            // Target Comparison
            const target = parseFloat(document.getElementById('target-' + tId).value) || 0;
            let resultText = "รอข้อมูล";
            let resultClass = "text-slate-500";
            if(total > 0) {
                if(parseFloat(passPercent) >= target) {
                    resultText = "ผ่านเกณฑ์";
                    resultClass = "text-green-600 font-bold";
                } else {
                    resultText = "ไม่ผ่านเกณฑ์";
                    resultClass = "text-red-600 font-bold";
                }
            }
            
            const html = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                <table class="mini-summary-table">
                    <thead><tr><th colspan="2">ระดับ 2 ขึ้นไป (ผ่าน)</th><th colspan="2">ต่ำกว่าระดับ 2 (ไม่ผ่าน)</th></tr></thead>
                    <tbody>
                        <tr><td class="font-bold text-green-700">${passCount} คน</td><td class="text-green-700">${passPercent}%</td><td class="font-bold text-red-700">${failCount} คน</td><td class="text-red-700">${failPercent}%</td></tr>
                    </tbody>
                </table>
                <div class="flex items-center justify-center p-2 border rounded bg-slate-50">
                    <div class="text-center">
                        <div class="text-slate-500 font-bold mb-1">ผลการประเมิน</div>
                        <div class="text-xl ${resultClass}">${resultText}</div>
                        <div class="text-[10px] text-slate-400">(เป้าหมาย ${target}%)</div>
                    </div>
                </div>
            </div>`; 
            
            document.getElementById('summary-' + tId).innerHTML = html; 
        }

        // Init
        const methods = ["การอธิบาย", "การสาธิต / ทดลอง", "การใช้เกมประกอบ", "สถานการณ์จำลอง", "กรณีตัวอย่าง", "บทบาทสมมุติ", "การแก้ไขสถานการณ์", "โปรแกรมสำเร็จรูป", "ศูนย์การเรียน", "ชุดการสอน", "คอมพิวเตอร์ช่วยสอน", "โครงงาน", "การถามตอบ", "การสืบสวนสอบสวน", "กลุ่มสืบค้นความรู้", "กลุ่มสัมพันธ์", "การเรียนรู้แบบร่วมมือ", "ความคิดรวบยอด", "อริยสัจ 4", "การศึกษาค้นคว้าด้วยตนเอง", "การทัศนะศึกษานอกสถานที่", "การเรียนรู้จากห้องสมุด", "การพัฒนากระบวนการคิด", "การอภิปรายกลุ่มย่อย", "การแก้ปัญหา"];
        function renderMethods() { const container = document.getElementById('teaching-methods'); methods.forEach(m => { const label = document.createElement('label'); label.className = "flex items-center gap-2 p-2 hover:bg-rose-50 rounded text-xs cursor-pointer border border-transparent hover:border-rose-200 transition w-full md:w-auto"; label.innerHTML = `<input type="checkbox" class="method-cb w-4 h-4 accent-rose-600" onchange="countMethods()"> <span>${m}</span>`; container.appendChild(label); }); }
        function countMethods() { document.getElementById('method-count').innerText = document.querySelectorAll('.method-cb:checked').length; }
        
        const planCriteria = [ { id: 'c1', title: '6.1 การวิเคราะห์ มาตรฐานฯ และ ตัวชี้วัด/KPA', items: ['ระบุตัวชี้วัดครบถ้วน', 'วิเคราะห์ KPA แยก 3 ด้าน', 'สอดคล้องกิจกรรมการเรียนรู้', 'สอดคล้องผลการเรียนรู้คาดหวัง', 'ครอบคลุมมาตรฐานการศึกษา'] }, { id: 'c2', title: '6.2 การออกแบบกิจกรรมการเรียนรู้', items: ['ออกแบบกิจกรรมเป็นขั้นตอน', 'ครบ 4 ด้าน', 'เหมาะสมจุดประสงค์', 'สอดคล้อง KPA', 'ปฏิบัติได้จริง'] }, { id: 'c3', title: '6.3 การออกแบบปฏิสัมพันธ์', items: ['ใช้กระบวนการกลุ่ม', 'มีส่วนร่วมหลากหลาย', 'กำหนดบทบาทชัดเจน', 'ปฏิบัติจริง', 'ผู้เรียนสนุกและเกิดการเรียนรู้'] }, { id: 'c4', title: '6.4 การออกแบบประเมินผล', items: ['ประเมินทุกแผนการสอน', 'วิธีการหลากหลาย', 'สอดคล้องจุดประสงค์', 'ปฏิบัติจริง', 'นำผลมาพัฒนา'] }, { id: 'c5', title: '6.5 การใช้สื่ออุปกรณ์', items: ['ใช้สื่อ/แหล่งเรียนรู้', 'กำหนดขั้นตอนชัดเจน', 'สื่อเหมาะสม', 'อุปกรณ์เพียงพอ', 'มีการพัฒนาสื่อ'] } ];
        function renderPlanEval() { const container = document.getElementById('plan-evaluation-logic'); planCriteria.forEach(c => { const div = document.createElement('div'); div.innerHTML = `<h4 class="font-bold text-slate-700 mb-2 border-l-4 border-rose-500 pl-2 text-sm">${c.title}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-1">${c.items.map(it => `<label class="flex items-center gap-2 text-xs p-1 hover:bg-rose-50 rounded cursor-pointer"><input type="checkbox" class="plan-cb" data-group="${c.id}" onchange="calcPlanScore()"> ${it}</label>`).join('')}</div>`; container.appendChild(div); }); }
        function calcPlanScore() { let total = 0; planCriteria.forEach(c => { const checked = document.querySelectorAll(`.plan-cb[data-group="${c.id}"]:checked`).length; let s = 0; if(checked >= 5) s = 4; else if(checked == 4) s = 3; else if(checked == 3) s = 2; else if(checked >= 1) s = 1; total += s; }); document.getElementById('plan-score').innerText = total; const q = document.getElementById('plan-quality'); if(total >= 18) q.innerText = "ดีมาก"; else if(total >= 14) q.innerText = "ดี"; else if(total >= 10) q.innerText = "พอใช้"; else q.innerText = "ปรับปรุง"; }
        
        const stds = [ { id: 1, name: "มาตรฐานที่ 1 คุณภาพของผู้เรียน", list: ["1.1 (1) การอ่าน เขียน สื่อสาร คิดคำนวณ", "1.1 (2) คิดวิเคราะห์ แก้ปัญหา", "1.1 (3) การสร้างนวัตกรรม", "1.1 (4) การใช้เทคโนโลยี", "1.1 (5) ผลสัมฤทธิ์ทางการเรียน", "1.1 (6) พื้นฐานเจตคติต่องานอาชีพ", "1.2 (1) ค่านิยมที่ดี", "1.2 (2) ภูมิใจในท้องถิ่น/ไทย", "1.2 (3) อยู่ร่วมกันบนความแตกต่าง", "1.2 (4) สุขภาวะกายและจิต"] }, { id: 2, name: "มาตรฐานที่ 2 กระบวนการบริหาร", list: ["2.1 วิสัยทัศน์/พันธกิจ", "2.2 ระบบบริหารจัดการ", "2.3 พัฒนาวิชาการเน้นคุณภาพ", "2.4 พัฒนาครู/บุคลากร", "2.5 สภาพแวดล้อมเอื้อเรียนรู้", "2.6 ระบบสารสนเทศ"] }, { id: 3, name: "มาตรฐานที่ 3 กระบวนการจัดการเรียนการสอน", list: ["3.1 คิดและปฏิบัติจริง", "3.2 ใช้สื่อ/แหล่งเรียนรู้", "3.3 บริหารจัดการเชิงบวก", "3.4 ตรวจสอบประเมินระบบ", "3.5 แลกเปลี่ยนเรียนรู้สะท้อนกลับ"] } ];
        function renderStd() { const body = document.getElementById('std-body'); let html = ''; stds.forEach(s => { html += `<tr class="bg-rose-50"><td colspan="2" class="text-left px-4 font-bold text-rose-700 italic text-xs py-2">${s.name}</td></tr>`; s.list.forEach(txt => { html += `<tr><td class="text-left px-4 text-xs">${txt}</td><td><select class="std-input std-${s.id} w-full text-center border-0 p-1 bg-white" onchange="calcStd(${s.id})"><option value="">-</option><option value="5">5</option><option value="4">4</option><option value="3">3</option><option value="2">2</option><option value="1">1</option></select></td></tr>`; }); }); body.innerHTML = html; }
        function renderStdQualitative() { const container = document.getElementById('std-qualitative-container'); if(!container) return; const standardTitles = [ { id: 1, title: "มาตรฐานที่ 1: คุณภาพของผู้เรียน" }, { id: 2, title: "มาตรฐานที่ 2: กระบวนการบริหารและการจัดการ" }, { id: 3, title: "มาตรฐานที่ 3: กระบวนการจัดการเรียนการสอนที่เน้นผู้เรียนเป็นสำคัญ" } ]; let html = ''; standardTitles.forEach(std => { html += `<div class="k-card avoid-break"><h3 class="font-bold text-rose-700 text-lg mb-4 border-b pb-2">${std.title}</h3><div class="space-y-4"><div class="avoid-break w-full"><label class="k-label">1. กระบวนการพัฒนา (เขียนวิธีการ/กระบวนการในการดำเนินงานอย่างเป็นขั้นตอน)</label><textarea id="std${std.id}-process" class="k-input h-24" placeholder="ระบุวิธีการ/กระบวนการในการดำเนินงาน..."></textarea></div><div class="avoid-break w-full"><label class="k-label">2. ผลการพัฒนา (ผลที่เกิดขึ้นจากกระบวนการพัฒนา)</label><textarea id="std${std.id}-result" class="k-input h-24" placeholder="ระบุผลที่เกิดขึ้น..."></textarea></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div class="avoid-break w-full"><label class="k-label text-green-700">3. จุดเด่น</label><textarea id="std${std.id}-strength" class="k-input h-24 border-green-200 bg-green-50" placeholder="ระบุจุดเด่น..."></textarea></div><div class="avoid-break w-full"><label class="k-label text-orange-700">4. จุดที่ควรพัฒนา</label><textarea id="std${std.id}-improvement" class="k-input h-24 border-orange-200 bg-orange-50" placeholder="ระบุจุดที่ควรพัฒนา..."></textarea></div></div></div></div>`; }); container.innerHTML = html; }
        function calcStd(id) { const ins = document.querySelectorAll(`.std-${id}`); let sum = 0, count = 0; ins.forEach(i => { if(i.value) { sum += parseFloat(i.value); count++; } }); const avg = count ? (sum/count).toFixed(2) : 0; let res = "-"; if(avg >= 4.5) res = "ยอดเยี่ยม"; else if(avg >= 3.5) res = "ดีเลิศ"; else if(avg >= 2.5) res = "ดี"; else res = "ปานกลาง/กำลังพัฒนา"; document.getElementById(`std-res-${id}`).innerHTML = `${avg}<br><small>(${res})</small>`; }
        window.calcStd = calcStd;
        window.onload = () => { renderStd(); renderStdQualitative(); addRow('edu-table'); addTeachRow('teach-t1'); addTeachRow('teach-t2'); addRow('special-task'); addRow('plan-table'); addRow('media-table-new'); addRow('inter-table'); addRow('res-table'); addRow('self-dev-table'); addResourceRow('learning-resources-table'); addAchieveRow('achieve-t1'); addAchieveRow('achieve-t2'); addEvalRow('attr-t1'); addEvalRow('attr-t2'); addEvalRow('read-t1'); addEvalRow('read-t2'); addDevActRow('dev-act-t1'); addRow('student-award-table'); addRow('teacher-award-table'); renderMethods(); renderPlanEval(); updateChart(1); updateChart(2); };
    </script>
</body>
</html>
