<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAR Online - โรงเรียนหางดงรัฐราษฎร์อุปถัมภ์</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- HTML2PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root { --k-red: #e11d48; --k-bg: #f8fafc; }
        body { font-family: 'Sarabun', sans-serif; background-color: var(--k-bg); color: #334155; }
        
        /* Table Styling */
        .k-table th { background: #ffe4e6; color: #9f1239; padding: 8px; border: 1px solid #fda4af; font-size: 0.85rem; white-space: nowrap; text-align: center; vertical-align: middle; }
        .k-table td { padding: 4px; border: 1px solid #e2e8f0; vertical-align: middle; }
        .k-table tfoot td { text-align: center !important; vertical-align: middle; font-weight: bold; background-color: #fff1f2; color: #881337; }
        
        /* Input Styling */
        .k-input, .k-select { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; background: white; transition: 0.2s; font-size: 14px; }
        .k-input:focus, .k-select:focus { border-color: var(--k-red); outline: none; box-shadow: 0 0 0 3px rgba(225,29,72,0.1); }
        .k-table input, .k-table select, .k-table textarea { width: 100%; border: 1px solid transparent; text-align: center; background: transparent; padding: 4px; font-size: 0.9rem; resize: vertical; min-height: 32px; }
        .k-table input:focus, .k-table textarea:focus, .k-table select:focus { background: white; border: 1px solid var(--k-red); border-radius: 4px; }

        /* Sidebar & Layout */
        .sidebar { width: 280px; background: white; border-right: 1px solid #e2e8f0; height: 100vh; position: fixed; left: 0; top: 0; overflow-y: auto; z-index: 50; transition: 0.3s; }
        .main-content { margin-left: 280px; padding: 2rem; width: calc(100% - 280px); }
        @media (max-width: 768px) { .sidebar { transform: translateX(-100%); } .sidebar.active { transform: translateX(0); } .main-content { margin-left: 0; width: 100%; padding: 1rem; } }

        /* Tabs */
        .tab-content { display: none; } 
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(5px)} to{opacity:1;transform:translateY(0)} }
        
        .nav-link { padding: 12px 20px; display: flex; align-items: center; gap: 10px; cursor: pointer; color: #64748b; border-left: 4px solid transparent; transition: 0.2s; font-weight: 500; }
        .nav-link.active { background: #fff1f2; color: #e11d48; border-left-color: #e11d48; font-weight: bold; }
        
        /* Utils */
        .w-grade-col { width: 40px; } .w-eval-col { width: 60px; } .min-w-subject { min-width: 200px; }
        .img-placeholder { width: 120px; height: 140px; background: #f1f5f9; border: 2px dashed #cbd5e1; display: flex; align-items: center; justify-content: center; flex-direction: column; cursor: pointer; position: relative; overflow: hidden; }
        .img-preview { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

<!-- Loading Overlay -->
<div id="loading" class="fixed inset-0 bg-black/80 z-[100] hidden flex flex-col items-center justify-center text-white backdrop-blur">
    <div class="w-16 h-16 border-4 border-white/30 border-t-rose-500 rounded-full animate-spin mb-4"></div>
    <h2 class="text-xl font-bold">กำลังประมวลผล...</h2>
</div>

<!-- Mobile Toggle -->
<button onclick="document.getElementById('sidebar').classList.toggle('active')" class="md:hidden fixed top-4 right-4 z-50 bg-white p-2 rounded shadow text-rose-600 border border-rose-100"><i class="ph-bold ph-list text-2xl"></i></button>

<!-- Sidebar -->
<aside class="sidebar" id="sidebar">
    <div class="p-6 text-center border-b border-gray-100 bg-white flex flex-col items-center gap-2">
        <img src="https://i.postimg.cc/0N30mLw5/logo-HDR.png" alt="Logo" class="w-[100px] h-auto object-contain">
        <div><h1 class="font-bold text-xl text-gray-800 tracking-tight">SAR Online</h1><p class="text-xs text-rose-600 font-medium">โรงเรียนหางดงรัฐราษฎร์อุปถัมภ์</p></div>
    </div>
    <nav class="py-4 space-y-1">
        <div class="nav-link active" onclick="switchTab(1)" id="link-1"><i class="ph-bold ph-user"></i> 1. ข้อมูลทั่วไป</div>
        <div class="nav-link" onclick="switchTab(2)" id="link-2"><i class="ph-bold ph-chalkboard-teacher"></i> 2. การปฏิบัติหน้าที่</div>
        <div class="nav-link" onclick="switchTab(3)" id="link-3"><i class="ph-bold ph-lightbulb"></i> 3. พัฒนาการสอน</div>
        <div class="nav-link" onclick="switchTab(4)" id="link-4"><i class="ph-bold ph-certificate"></i> 4. พัฒนาตนเอง</div>
        <div class="nav-link" onclick="switchTab(5)" id="link-5"><i class="ph-bold ph-trophy"></i> 5. ผลงาน</div>
        <div class="nav-link" onclick="switchTab(6)" id="link-6"><i class="ph-bold ph-chart-bar"></i> 6. ผลสัมฤทธิ์</div>
        <div class="nav-link" onclick="switchTab(7)" id="link-7"><i class="ph-bold ph-check-square"></i> 7. ประเมินแผน</div>
        <div class="nav-link" onclick="switchTab(8)" id="link-8"><i class="ph-bold ph-star"></i> 8. มาตรฐาน</div>
    </nav>
    <div class="p-4 mt-auto border-t space-y-2">
        <button type="button" onclick="saveDraft()" class="w-full mb-2 bg-yellow-500 hover:bg-yellow-600 text-white py-2 rounded-lg shadow-sm font-bold transition flex justify-center items-center gap-2"><i class="ph-bold ph-floppy-disk"></i> บันทึกแบบร่าง</button>
        <button type="button" onclick="exportPDFClient()" class="w-full mb-2 bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg shadow-sm font-bold transition flex justify-center items-center gap-2"><i class="ph-bold ph-printer"></i> พิมพ์ PDF</button>
        <button onclick="submitData()" class="w-full bg-rose-600 hover:bg-rose-700 text-white py-2.5 rounded-lg shadow-md font-bold transition flex justify-center items-center gap-2"><i class="ph-bold ph-paper-plane-right"></i> ส่งข้อมูล (Simulate)</button>
    </div>
</aside>

<!-- Main Content -->
<main class="main-content">
    <form id="sarForm">
        <!-- Tab 1 -->
        <div id="tab-1" class="tab-content active">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 border-b pb-4 mb-6"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-identification-card text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 1: ข้อมูลทั่วไป</h2></div>
                <div class="flex flex-col md:flex-row gap-8">
                    <div class="flex-shrink-0 flex flex-col items-center">
                        <div class="img-placeholder rounded-lg" onclick="document.getElementById('pf_input').click()"><img id="pf_preview" class="img-preview hidden"><i class="ph-duotone ph-camera text-3xl text-gray-300"></i><span class="text-xs text-gray-400 mt-2">รูปถ่าย</span></div>
                        <input type="file" id="pf_input" class="hidden" accept="image/*" onchange="preview(this,'pf_preview', 'profile_pic')"><input type="hidden" name="profile_pic" id="profile_pic">
                    </div>
                    <div class="flex-grow space-y-4">
                        <div><label class="k-label">ชื่อ - นามสกุล</label><input type="text" name="full_name" class="k-input"></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">ประจำปีการศึกษา</label><input type="text" name="academic_year" value="2568" class="k-input font-bold text-rose-600 bg-rose-50 text-center"></div><div><label class="k-label">เลขที่ตำแหน่ง</label><input type="text" name="position_no" class="k-input"></div></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">ตำแหน่ง</label><select name="position" class="k-select"><option value="">- เลือก -</option><option>ครูผู้ช่วย</option><option>ครู</option><option>อัตราจ้าง</option></select></div><div><label class="k-label">วิทยฐานะ</label><select name="standing" class="k-select"><option value="">- เลือก -</option><option>ไม่มี</option><option>ชำนาญการ</option><option>ชำนาญการพิเศษ</option><option>เชี่ยวชาญ</option><option>เชี่ยวชาญพิเศษ</option></select></div></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">เงินเดือน</label><input type="number" name="salary" class="k-input" placeholder="ไม่ต้องใส่ลูกน้ำ"></div><div><label class="k-label">เงินวิทยฐานะ</label><input type="number" name="standing_money" class="k-input" placeholder="ไม่ต้องใส่ลูกน้ำ"></div></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">วัน/เดือน/ปี เกิด</label><div id="birthdate-container" class="grid grid-cols-3 gap-2"></div><input type="hidden" name="birth_date" id="birthdate"></div><div><label class="k-label">อายุ</label><input type="text" id="age_display" class="k-input bg-gray-50 text-center" readonly placeholder="- ปี - เดือน"></div></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">วัน/เดือน/ปี บรรจุ</label><div id="workdate-container" class="grid grid-cols-3 gap-2"></div><input type="hidden" name="hire_date" id="workdate"></div><div><label class="k-label">อายุราชการ</label><input type="text" id="service_display" class="k-input bg-gray-50 text-center" readonly placeholder="- ปี - เดือน"></div></div>
                        <div class="grid md:grid-cols-2 gap-4"><div><label class="k-label">กลุ่มสาระฯ</label><input type="text" name="department" class="k-input"></div><div><label class="k-label">สังกัด</label><input type="text" name="affiliation" class="k-input"></div></div>
                    </div>
                </div>
                <div class="mt-8 pt-6 border-t"><h4 class="font-bold text-gray-700 mb-3 text-lg">ประวัติการศึกษา</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="edu-table"><thead><tr><th class="w-16">ที่</th><th>วุฒิการศึกษา</th><th>วิชาเอก</th><th>สถาบัน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addRow('edu-table')" class="mt-2 text-sm text-rose-600 font-bold flex items-center gap-1">+ เพิ่มวุฒิ</button></div>
            </div>
        </div>

        <!-- Tab 2 -->
        <div id="tab-2" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 space-y-10">
                <div class="flex items-center gap-3 border-b pb-4"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-chalkboard-teacher text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 2: การปฏิบัติหน้าที่</h2></div>
                <div class="space-y-6">
                    <h4 class="font-bold text-gray-800 border-l-4 border-rose-500 pl-3">2.1 ปฏิบัติการสอน</h4>
                    <div class="bg-gray-50 p-4 rounded-lg border"><h5 class="font-bold text-rose-700 mb-3">ภาคเรียนที่ 1</h5><div class="overflow-x-auto border rounded-lg bg-white"><table class="w-full k-table" id="teach-t1"><thead><tr><th class="w-12">ที่</th><th class="w-24">รหัสวิชา</th><th>ชื่อรายวิชา</th><th class="w-20">ชั้น</th><th class="w-20">จำนวนห้อง</th><th class="w-24">ชม./สัปดาห์</th><th class="w-24">นร.เรียนร่วม (คน)</th><th class="w-8"></th></tr></thead><tbody></tbody><tfoot><tr class="bg-rose-50 font-bold text-rose-800"><td colspan="4" class="text-right pr-4">รวม</td><td id="t1-room-total">0</td><td id="t1-hr-total">0</td><td id="t1-sp-total">0</td><td></td></tr></tfoot></table></div><button type="button" onclick="addTeachRow('teach-t1')" class="mt-2 text-sm text-rose-600 font-bold">+ เพิ่มรายวิชา</button></div>
                    <div class="bg-gray-50 p-4 rounded-lg border"><h5 class="font-bold text-rose-700 mb-3">ภาคเรียนที่ 2</h5><div class="overflow-x-auto border rounded-lg bg-white"><table class="w-full k-table" id="teach-t2"><thead><tr><th class="w-12">ที่</th><th class="w-24">รหัสวิชา</th><th>ชื่อรายวิชา</th><th class="w-20">ชั้น</th><th class="w-20">จำนวนห้อง</th><th class="w-24">ชม./สัปดาห์</th><th class="w-24">นร.เรียนร่วม (คน)</th><th class="w-8"></th></tr></thead><tbody></tbody><tfoot><tr class="bg-rose-50 font-bold text-rose-800"><td colspan="4" class="text-right pr-4">รวม</td><td id="t2-room-total">0</td><td id="t2-hr-total">0</td><td id="t2-sp-total">0</td><td></td></tr></tfoot></table></div><button type="button" onclick="addTeachRow('teach-t2')" class="mt-2 text-sm text-rose-600 font-bold">+ เพิ่มรายวิชา</button></div>
                </div>
                <div><h4 class="font-bold text-gray-800 mb-3 border-l-4 border-rose-500 pl-3">2.2 ปฏิบัติการสอนแทน</h4><div class="grid md:grid-cols-2 gap-6 bg-gray-50 p-4 rounded-lg border"><div><label class="k-label">ภาคเรียนที่ 1 (คาบ)</label><input type="number" name="sub_teach_t1" class="k-input text-center font-bold text-lg"></div><div><label class="k-label">ภาคเรียนที่ 2 (คาบ)</label><input type="number" name="sub_teach_t2" class="k-input text-center font-bold text-lg"></div></div></div>
                <div><h4 class="font-bold text-gray-800 mb-3 border-l-4 border-blue-500 pl-3">2.3 กิจกรรมพัฒนาผู้เรียนที่รับผิดชอบ</h4><div class="flex flex-col gap-6"><div class="border rounded-lg p-3"><h5 class="font-bold text-blue-700 mb-2 text-sm">ภาคเรียนที่ 1</h5><div class="overflow-x-auto"><table class="w-full k-table" id="act-t1"><thead><tr><th class="w-10">ที่</th><th class="w-80">กิจกรรม/ชุมนุม</th><th>ชั้น</th><th>นร.(รวม)</th><th>ผ่าน</th><th>ไม่ผ่าน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addActRow('act-t1')" class="mt-2 text-xs text-blue-600 font-bold">+ เพิ่มกิจกรรม</button></div><div class="border rounded-lg p-3"><h5 class="font-bold text-blue-700 mb-2 text-sm">ภาคเรียนที่ 2</h5><div class="overflow-x-auto"><table class="w-full k-table" id="act-t2"><thead><tr><th class="w-10">ที่</th><th class="w-80">กิจกรรม/ชุมนุม</th><th>ชั้น</th><th>นร.(รวม)</th><th>ผ่าน</th><th>ไม่ผ่าน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addActRow('act-t2')" class="mt-2 text-xs text-blue-600 font-bold">+ เพิ่มกิจกรรม</button></div></div></div>
                <div><h4 class="font-bold text-gray-800 mb-3 border-l-4 border-green-500 pl-3">2.4 ปฏิบัติหน้าที่ครูที่ปรึกษา</h4><div class="grid md:grid-cols-2 gap-6"><div class="bg-gray-50 p-3 rounded border"><h5 class="font-bold text-gray-700 mb-2 text-sm">ภาคเรียนที่ 1</h5><div class="grid grid-cols-4 gap-2"><div class="col-span-4"><input type="text" name="adv_room_t1" class="k-input" placeholder="ระบุชั้น/ห้อง"></div><div><label class="text-xs">ชาย</label><input type="number" name="adv_m_t1" id="adv_m_t1" class="k-input" oninput="calcAdv(1)"></div><div><label class="text-xs">หญิง</label><input type="number" name="adv_f_t1" id="adv_f_t1" class="k-input" oninput="calcAdv(1)"></div><div class="col-span-2"><label class="text-xs font-bold">รวมทั้งสิ้น</label><input type="number" id="adv_total_t1" name="adv_total_t1" class="k-input bg-gray-100 font-bold" readonly></div></div></div><div class="bg-gray-50 p-3 rounded border"><h5 class="font-bold text-gray-700 mb-2 text-sm">ภาคเรียนที่ 2</h5><div class="grid grid-cols-4 gap-2"><div class="col-span-4"><input type="text" name="adv_room_t2" class="k-input" placeholder="ระบุชั้น/ห้อง"></div><div><label class="text-xs">ชาย</label><input type="number" name="adv_m_t2" id="adv_m_t2" class="k-input" oninput="calcAdv(2)"></div><div><label class="text-xs">หญิง</label><input type="number" name="adv_f_t2" id="adv_f_t2" class="k-input" oninput="calcAdv(2)"></div><div class="col-span-2"><label class="text-xs font-bold">รวมทั้งสิ้น</label><input type="number" id="adv_total_t2" name="adv_total_t2" class="k-input bg-gray-100 font-bold" readonly></div></div></div></div></div>
                <div><h4 class="font-bold text-gray-800 mb-3 border-l-4 border-orange-500 pl-3">2.5 งานพิเศษ</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="sp-table"><thead><tr><th class="w-12">ที่</th><th class="w-1/4">กลุ่มงาน</th><th>งานที่ได้รับมอบหมาย</th><th class="w-24">ชม./สัปดาห์</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addSpRow()" class="mt-2 text-sm text-orange-600 font-bold">+ เพิ่มงาน</button></div>
            </div>
        </div>

        <!-- Tab 3 -->
        <div id="tab-3" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 space-y-10">
                <div class="flex items-center gap-3 border-b pb-4"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-lightbulb text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 3: พัฒนาการสอน</h2></div>
                <div><h4 class="font-bold text-gray-700 mb-2">3.1 จัดทำแผนการจัดการเรียนรู้</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="plan-table"><thead><tr><th class="w-12">ที่</th><th class="w-24">รหัสวิชา</th><th>รายวิชา</th><th>ระดับชั้น</th><th>จำนวน/แผน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addPlanRow()" class="mt-2 text-sm text-rose-600 font-bold">+ เพิ่มแผน</button></div>
                <div><h4 class="font-bold text-gray-700 mb-2">3.2 ผลิตสื่อ / นวัตกรรม</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="media-table-new"><thead><tr><th class="w-12">ที่</th><th>ชื่อสื่อ/นวัตกรรม</th><th>รายวิชา</th><th>จำนวน (ชิ้น)</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addMediaRow()" class="mt-2 text-sm text-rose-600 font-bold">+ เพิ่มสื่อ</button></div>
                <div><h4 class="font-bold text-gray-800 mb-3 border-l-4 border-indigo-500 pl-3">3.3 แผนบูรณาการและวิจัย</h4><div class="flex flex-col gap-6"><div><h5 class="font-bold text-indigo-700 mb-2">แผนบูรณาการ</h5><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="inter-table"><thead><tr><th class="w-12">ที่</th><th>เรื่อง</th><th>จำนวนชั่วโมง</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addIntegRow()" class="mt-2 text-sm text-indigo-600 font-bold">+ เพิ่มแผนบูรณาการ</button></div><div><h5 class="font-bold text-indigo-700 mb-2">วิจัยในชั้นเรียน</h5><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="res-table"><thead><tr><th class="w-12">ที่</th><th>เรื่อง</th><th>รายวิชา</th><th>ระดับชั้น</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addResRow()" class="mt-2 text-sm text-indigo-600 font-bold">+ เพิ่มวิจัย</button></div></div></div>
                <div class="bg-gray-50 p-4 rounded-lg border"><div class="flex justify-between items-center mb-3"><h4 class="font-bold text-gray-700">3.4 รูปแบบ / วิธีการจัดกิจกรรมการเรียนการสอน</h4><span class="text-lg bg-white border px-4 py-2 rounded-full shadow-sm">เลือกแล้ว: <span id="method-count" class="font-bold text-rose-600 text-2xl">0</span> วิธี</span></div><div id="methods-wrap" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-3 text-sm"></div></div>
                <div><h4 class="font-bold text-gray-700 mb-2">3.5 แหล่งเรียนรู้</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="learning-resources-table"><thead><tr><th class="w-12">ที่</th><th>แหล่งเรียนรู้</th><th>จำนวนครั้ง</th><th>ผลการใช้</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addResourceRow('learning-resources-table')" class="mt-2 text-sm text-rose-600 font-bold">+ เพิ่มแหล่งเรียนรู้</button></div>
            </div>
        </div>

        <!-- Tab 4 -->
        <div id="tab-4" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 border-b pb-4 mb-6"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-certificate text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 4: การพัฒนาตนเอง</h2></div>
                <div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="self-dev-table"><thead><tr><th class="w-12">ที่</th><th class="w-48">วัน/เดือน/ปี</th><th>เรื่อง/หัวข้ออบรม</th><th>หน่วยงาน</th><th class="w-20">ชม.</th><th class="w-40">หลักฐาน</th><th class="w-8"></th></tr></thead><tbody></tbody><tfoot><tr class="bg-yellow-50 font-bold"><td colspan="3" class="text-right pr-4">สรุปการพัฒนาตนเอง</td><td class="text-center"><span id="dev-count">0</span> ครั้ง</td><td class="text-center"><span id="dev-hrs">0</span> ชม.</td><td colspan="2"></td></tr></tfoot></table></div><button type="button" onclick="addDevRow()" class="mt-2 text-sm text-rose-600 hover:underline">+ เพิ่มรายการ</button>
            </div>
        </div>

        <!-- Tab 5 -->
        <div id="tab-5" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 space-y-8">
                <div class="flex items-center gap-3 border-b pb-4"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-trophy text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 5: ผลงานที่ภาคภูมิใจ</h2></div>
                <div><h4 class="font-bold text-blue-800 mb-2">5.1 ผลงานนักเรียน</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="student-award-table"><thead><tr><th class="w-12">ที่</th><th class="min-w-[200px]">ชื่อนักเรียน</th><th>ระดับผลงาน</th><th>รางวัล</th><th>หน่วยงาน</th><th class="w-40">หลักฐาน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addAwardRow('student-award-table',1)" class="mt-2 text-sm text-blue-600 hover:underline">+ เพิ่มผลงาน</button></div>
                <div><h4 class="font-bold text-rose-800 mb-2">5.2 ผลงานครู</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table" id="teacher-award-table"><thead><tr><th class="w-12">ที่</th><th>ระดับผลงาน</th><th>รางวัล</th><th>หน่วยงาน</th><th class="w-40">หลักฐาน</th><th class="w-8"></th></tr></thead><tbody></tbody></table></div><button type="button" onclick="addAwardRow('teacher-award-table',0)" class="mt-2 text-sm text-rose-600 hover:underline">+ เพิ่มผลงาน</button></div>
            </div>
        </div>

        <!-- Tab 6 -->
        <div id="tab-6" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100 space-y-12">
                <div class="flex items-center gap-3 border-b pb-4"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-chart-bar text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 6: ผลสัมฤทธิ์ทางการเรียน</h2></div>
                <!-- 6.1 Academic -->
                <div><h3 class="text-lg font-bold text-gray-800 border-l-4 border-rose-600 pl-3 mb-4">6.1 ผลสัมฤทธิ์ทางการเรียน</h3>
                    <div class="mb-8"><h4 class="font-bold text-gray-700 bg-gray-50 p-2 rounded mb-2">ภาคเรียนที่ 1</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table text-xs" id="achieve-t1"><thead><tr><th class="w-8">ที่</th><th class="min-w-subject">รายวิชา</th><th class="w-20">ห้อง</th><th class="w-20">รวม</th><th class="w-grade-col">4</th><th class="w-grade-col">3.5</th><th class="w-grade-col">3</th><th class="w-grade-col">2.5</th><th class="w-grade-col">2</th><th class="w-grade-col">1.5</th><th class="w-grade-col">1</th><th class="w-grade-col">0</th><th class="w-grade-col">ร</th><th class="w-grade-col">มส</th><th class="w-6"></th></tr></thead><tbody></tbody><tfoot class="bg-rose-50 font-bold text-rose-900"><tr><td colspan="3" class="text-right pr-2">รวมจำนวน</td><td id="t1-total-std">0</td><td id="t1-g4">0</td><td id="t1-g35">0</td><td id="t1-g3">0</td><td id="t1-g25">0</td><td id="t1-g2">0</td><td id="t1-g15">0</td><td id="t1-g1">0</td><td id="t1-g0">0</td><td id="t1-gr">0</td><td id="t1-gms">0</td><td></td></tr><tr class="text-blue-800"><td colspan="3" class="text-right pr-2">คิดเป็นร้อยละ (%)</td><td>100%</td><td id="t1-p4">0</td><td id="t1-p35">0</td><td id="t1-p3">0</td><td id="t1-p25">0</td><td id="t1-p2">0</td><td id="t1-p15">0</td><td id="t1-p1">0</td><td id="t1-p0">0</td><td id="t1-pr">0</td><td id="t1-pms">0</td><td></td></tr></tfoot></table></div><button type="button" onclick="addAchieveRow('achieve-t1')" class="text-xs text-rose-600 mt-1 font-bold">+ เพิ่มวิชา</button><div class="mt-4 grid md:grid-cols-2 gap-4 bg-gray-50 p-3 rounded border"><div><div class="text-sm font-bold">ผลการเรียนระดับ 2 ขึ้นไป</div><div class="text-2xl font-bold text-green-600" id="t1-kpi-2">0 คน (0.00%)</div></div><div><div class="text-sm font-bold">ผลการเรียนระดับ 3 ขึ้นไป</div><div class="text-2xl font-bold text-blue-600" id="t1-kpi-3">0 คน (0.00%)</div></div><div class="col-span-2 flex items-center gap-2 border-t pt-2 mt-2"><span class="text-sm font-bold text-gray-700">เป้าหมายสถานศึกษา (ระดับ 3 ขึ้นไป):</span><input type="number" class="border rounded w-16 text-center px-1" value="70" onchange="calcAchieve('achieve-t1')" id="t1-target">%<span id="t1-judge" class="font-bold px-2 py-1 rounded text-white text-xs bg-gray-400">รอประเมิน</span></div></div><div class="h-48 border rounded p-2 mt-2 bg-white"><canvas id="chart1"></canvas></div><input type="hidden" name="ach1_chart" id="ach1_chart"></div>
                    <div><h4 class="font-bold text-gray-700 bg-gray-50 p-2 rounded mb-2">ภาคเรียนที่ 2</h4><div class="overflow-x-auto border rounded-lg"><table class="w-full k-table text-xs" id="achieve-t2"><thead><tr><th class="w-8">ที่</th><th class="min-w-subject">รายวิชา</th><th class="w-20">ห้อง</th><th class="w-20">รวม</th><th class="w-grade-col">4</th><th class="w-grade-col">3.5</th><th class="w-grade-col">3</th><th class="w-grade-col">2.5</th><th class="w-grade-col">2</th><th class="w-grade-col">1.5</th><th class="w-grade-col">1</th><th class="w-grade-col">0</th><th class="w-grade-col">ร</th><th class="w-grade-col">มส</th><th class="w-6"></th></tr></thead><tbody></tbody><tfoot class="bg-rose-50 font-bold text-rose-900"><tr><td colspan="3" class="text-right pr-2">รวมจำนวน</td><td id="t2-total-std">0</td><td id="t2-g4">0</td><td id="t2-g35">0</td><td id="t2-g3">0</td><td id="t2-g25">0</td><td id="t2-g2">0</td><td id="t2-g15">0</td><td id="t2-g1">0</td><td id="t2-g0">0</td><td id="t2-gr">0</td><td id="t2-gms">0</td><td></td></tr><tr class="text-blue-800"><td colspan="3" class="text-right pr-2">คิดเป็นร้อยละ (%)</td><td>100%</td><td id="t2-p4">0</td><td id="t2-p35">0</td><td id="t2-p3">0</td><td id="t2-p25">0</td><td id="t2-p2">0</td><td id="t2-p15">0</td><td id="t2-p1">0</td><td id="t2-p0">0</td><td id="t2-pr">0</td><td id="t2-pms">0</td><td></td></tr></tfoot></table></div><button type="button" onclick="addAchieveRow('achieve-t2')" class="text-xs text-rose-600 mt-1 font-bold">+ เพิ่มวิชา</button><div class="mt-4 grid md:grid-cols-2 gap-4 bg-gray-50 p-3 rounded border"><div><div class="text-sm font-bold">ผลการเรียนระดับ 2 ขึ้นไป</div><div class="text-2xl font-bold text-green-600" id="t2-kpi-2">0 คน (0.00%)</div></div><div><div class="text-sm font-bold">ผลการเรียนระดับ 3 ขึ้นไป</div><div class="text-2xl font-bold text-blue-600" id="t2-kpi-3">0 คน (0.00%)</div></div><div class="col-span-2 flex items-center gap-2 border-t pt-2 mt-2"><span class="text-sm font-bold text-gray-700">เป้าหมายสถานศึกษา (ระดับ 3 ขึ้นไป):</span><input type="number" class="border rounded w-16 text-center px-1" value="70" onchange="calcAchieve('achieve-t2')" id="t2-target">%<span id="t2-judge" class="font-bold px-2 py-1 rounded text-white text-xs bg-gray-400">รอประเมิน</span></div></div><div class="h-48 border rounded p-2 mt-2 bg-white"><canvas id="chart2"></canvas></div><input type="hidden" name="ach2_chart" id="ach2_chart"></div>
                </div>
                <!-- 6.2 & 6.3 & 6.4 -->
                <div><h3 class="text-lg font-bold text-gray-800 border-l-4 border-purple-600 pl-3 mb-4">6.2 การประเมินคุณลักษณะอันพึงประสงค์</h3><div class="flex flex-col gap-6" id="attr-wrapper"></div></div>
                <div><h3 class="text-lg font-bold text-gray-800 border-l-4 border-orange-600 pl-3 mb-4">6.3 การอ่าน คิดวิเคราะห์ และเขียน</h3><div class="flex flex-col gap-6" id="read-wrapper"></div></div>
                <div><h3 class="text-lg font-bold text-gray-800 border-l-4 border-gray-600 pl-3 mb-4">6.4 ร่องรอยและหลักฐานการปฏิบัติงาน</h3><textarea name="evidence_text" class="w-full border rounded p-3 text-sm" rows="4" placeholder="ระบุเอกสาร/หลักฐาน..."></textarea></div>
            </div>
        </div>

        <!-- Tab 7 -->
        <div id="tab-7" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 border-b pb-4 mb-6"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-check-square text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 7: ผลการประเมินแผน</h2></div>
                <div id="plan-eval-container" class="space-y-6"></div>
                <div class="mt-8 p-6 bg-gray-50 rounded-lg border border-gray-200 flex flex-col items-center"><div class="text-gray-600">คะแนนรวม (เต็ม 20)</div><div id="plan-eval-total" class="text-4xl font-bold text-rose-600 my-2">0</div><div class="text-lg font-bold text-gray-700">ระดับคุณภาพ: <span id="plan-eval-level" class="text-blue-600">-</span></div></div>
            </div>
        </div>

        <!-- Tab 8 -->
        <div id="tab-8" class="tab-content">
            <div class="bg-white p-8 rounded-xl shadow-sm border border-gray-100">
                <div class="flex items-center gap-3 border-b pb-4 mb-6"><div class="w-10 h-10 rounded-full bg-rose-100 flex items-center justify-center text-rose-600"><i class="ph-fill ph-star text-xl"></i></div><h2 class="text-xl font-bold text-gray-800">ส่วนที่ 8: มาตรฐานการศึกษา</h2></div>
                <div id="std-container" class="space-y-8"></div>
                <!-- Signature -->
                <div class="mt-12 text-center pt-8 border-t">
                    <label class="block text-gray-700 mb-2 font-bold">ลงชื่อผู้รายงาน</label>
                    <div class="w-64 h-32 border-2 border-dashed border-gray-300 mx-auto flex items-center justify-center rounded-lg relative overflow-hidden bg-gray-50 hover:bg-gray-100 transition cursor-pointer" onclick="document.getElementById('sig_file_input').click()"><img id="sig_preview_manual" class="absolute inset-0 w-full h-full object-contain hidden"><div id="sig_placeholder" class="text-center"><i class="ph-duotone ph-signature text-3xl text-gray-400"></i><div class="text-gray-400 text-xs mt-1">คลิกเพื่ออัปโหลดลายเซ็น</div></div></div>
                    <input type="file" id="sig_file_input" class="hidden" accept="image/*" onchange="preview(this,'sig_preview_manual','signature_img'); document.getElementById('sig_placeholder').style.display='none';"><input type="hidden" name="signature_img" id="signature_img">
                    <div class="mt-2 font-bold text-gray-800 text-lg" id="signer_name">-</div>
                </div>
            </div>
        </div>
    </form>
</main>

<script>
    // --- Navigation ---
    function showTab(n){ document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.querySelectorAll('.nav-link').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+n).classList.add('active'); document.getElementById('link-'+n).classList.add('active'); }
    function switchTab(n){ showTab(n); }
    
    // --- Image Preview ---
    function preview(i,pid,hid){ if(i.files[0]){ const r=new FileReader(); r.onload=e=>{ if(pid){document.getElementById(pid).src=e.target.result; document.getElementById(pid).classList.remove('hidden');} document.getElementById(hid).value=e.target.result; }; r.readAsDataURL(i.files[0]); } }
    function handleImgs(i){ const c=i.closest('td'),d=c.querySelector('.d-img'),h=c.querySelector('.h-img'),a=h.value?JSON.parse(h.value):[]; Array.from(i.files).forEach(f=>{ const r=new FileReader(); r.onload=e=>{ d.innerHTML+=`<img src="${e.target.result}" class="w-16 h-16 rounded border object-cover">`; a.push(e.target.result); h.value=JSON.stringify(a); }; r.readAsDataURL(f); }); }
    
    // --- Table Helpers ---
    function reIndex(id){ document.querySelectorAll(`#${id} tbody tr`).forEach((r,i)=>r.querySelector('.row-index').innerText=i+1); if(id.includes('teach')) calcTeachTotal(id); if(id.includes('achieve')) calcAchieve(id); if(id.includes('attr') || id.includes('read')) calcEvalTotal(id); }
    function del(b){ const t=b.closest('table').id; b.closest('tr').remove(); reIndex(t); }
    const rowHTML = (cells) => `<tr><td class="row-index text-center font-bold text-gray-400"></td>${cells}<td><button type="button" onclick="del(this)" class="text-red-400 hover:text-red-600 font-bold px-2 w-6">×</button></td></tr>`;
    
    // --- Row Adders ---
    function addRow(id) { let h=''; if(id=='edu-table') h=rowHTML('<td><input type="text" class="text-left"></td><td><input type="text"></td><td><input type="text"></td>'); if(id=='sp-table') h=rowHTML('<td><input type="text" class="text-left"></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="number"></td>'); if(id=='plan-table') h=rowHTML('<td><input type="text" class="w-20"></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="text"></td><td><input type="number"></td>'); if(id=='media-table-new') h=rowHTML('<td><textarea rows="1" class="text-left"></textarea></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="number"></td>'); if(id=='inter-table') h=rowHTML('<td><textarea rows="1" class="text-left"></textarea></td><td><input type="number"></td>'); if(id=='res-table') h=rowHTML('<td><textarea rows="1" class="text-left"></textarea></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="text"></td>'); if(id=='learning-resources-table') h=rowHTML('<td><textarea rows="1" class="text-left"></textarea></td><td><input type="number"></td><td><textarea rows="1" class="text-left"></textarea></td>'); if(id=='self-dev-table') h=rowHTML('<td><input type="text" placeholder="ว/ด/ป" class="w-24"></td><td><textarea rows="2" class="text-left"></textarea></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="number" class="dev-hr" oninput="calcDevTotal()"></td><td class="p-1"><label class="cursor-pointer bg-gray-100 text-xs px-2 py-1 rounded">+<input type="file" class="hidden" multiple accept="image/*" onchange="handleImgs(this)"></label><div class="d-img flex flex-wrap gap-1 mt-1 justify-center"></div><textarea class="h-img hidden"></textarea></td>'); if(id=='student-award-table') h=rowHTML('<td><textarea rows="2" class="text-left" placeholder="ชื่อสกุล"></textarea></td><td><select class="k-select"><option>ระดับชาติ</option><option>ระดับภาค</option><option>ระดับจังหวัด</option><option>ระดับเขตพื้นที่</option></select></td><td><textarea rows="1" class="text-left"></textarea></td><td><textarea rows="1" class="text-left"></textarea></td><td class="p-1"><label class="cursor-pointer bg-gray-100 text-xs px-2 py-1 rounded">+<input type="file" class="hidden" multiple accept="image/*" onchange="handleImgs(this)"></label><div class="d-img flex flex-wrap gap-1 mt-1 justify-center"></div><textarea class="h-img hidden"></textarea></td>'); if(id=='teacher-award-table') h=rowHTML('<td><select class="k-select"><option>ระดับชาติ</option><option>ระดับภาค</option><option>ระดับจังหวัด</option><option>ระดับเขตพื้นที่</option></select></td><td><textarea rows="1" class="text-left"></textarea></td><td><textarea rows="1" class="text-left"></textarea></td><td class="p-1"><label class="cursor-pointer bg-gray-100 text-xs px-2 py-1 rounded">+<input type="file" class="hidden" multiple accept="image/*" onchange="handleImgs(this)"></label><div class="d-img flex flex-wrap gap-1 mt-1 justify-center"></div><textarea class="h-img hidden"></textarea></td>'); document.querySelector(`#${id} tbody`).insertAdjacentHTML('beforeend', h); reIndex(id); }
    function addTeachRow(id){ document.querySelector(`#${id} tbody`).insertAdjacentHTML('beforeend', rowHTML('<td><input type="text" class="w-24"></td><td><textarea rows="1" class="text-left"></textarea></td><td><input type="text"></td><td><input type="number" class="t-room" oninput="calcTeachTotal(\''+id+'\')"></td><td><input type="number" class="t-hr" oninput="calcTeachTotal(\''+id+'\')"></td><td><input type="number" class="t-sp" oninput="calcTeachTotal(\''+id+'\')"></td>')); reIndex(id); }
    function addActRow(id){ document.querySelector(`#${id} tbody`).insertAdjacentHTML('beforeend', rowHTML('<td><textarea rows="1" class="text-left"></textarea></td><td><input type="text" class="w-16"></td><td><input type="number" readonly class="bg-gray-100 font-bold"></td><td><input type="number" oninput="calcActTotal(this)"></td><td><input type="number" oninput="calcActTotal(this)"></td>')); reIndex(id); }
    function addSpRow(){ addRow('sp-table'); } function addPlanRow(){ addRow('plan-table'); } function addMediaRow(){ addRow('media-table-new'); } function addIntegRow(){ addRow('inter-table'); } function addResRow(){ addRow('res-table'); } function addResourceRow(){ addRow('learning-resources-table'); } function addDevRow(){ addRow('self-dev-table'); } function addAwardRow(id,hasN){ addRow(id); }

    // --- Calculations ---
    function calcAge(d,m,y) { if(!d||!m||!y) return; const now = new Date(); const birth = new Date(y-543, m-1, d); let years = now.getFullYear() - birth.getFullYear(); let months = now.getMonth() - birth.getMonth(); if (now.getDate() < birth.getDate()) months--; if (months < 0) { years--; months += 12; } document.getElementById('age_display').value = years + " ปี " + months + " เดือน"; }
    function calcService(d,m,y) { if(!d||!m||!y) return; const now = new Date(); const start = new Date(y-543, m-1, d); let years = now.getFullYear() - start.getFullYear(); let months = now.getMonth() - start.getMonth(); if (now.getDate() < start.getDate()) months--; if (months < 0) { years--; months += 12; } document.getElementById('service_display').value = years + " ปี " + months + " เดือน"; }
    function calcTeachTotal(id) { let r=0, h=0, s=0; document.querySelectorAll(`#${id} tbody tr`).forEach(row => { r += Number(row.querySelector('.t-room')?.value || 0); h += Number(row.querySelector('.t-hr')?.value || 0); s += Number(row.querySelector('.t-sp')?.value || 0); }); const prefix = id === 'teach-t1' ? 't1' : 't2'; document.getElementById(`${prefix}-room-total`).innerText = r; document.getElementById(`${prefix}-hr-total`).innerText = h; document.getElementById(`${prefix}-sp-total`).innerText = s; }
    function calcActTotal(inp) { const tr = inp.closest('tr'); const p = Number(tr.querySelectorAll('input')[2].value||0); const f = Number(tr.querySelectorAll('input')[3].value||0); tr.querySelectorAll('input')[1].value = p+f; }
    function calcAdv(term) { const m = Number(document.getElementById(`adv_m_t${term}`).value || 0); const f = Number(document.getElementById(`adv_f_t${term}`).value || 0); document.getElementById(`adv_total_t${term}`).value = m + f; }
    function updateMethodCount() { document.getElementById('method-count').innerText = document.querySelectorAll('input[name="methods"]:checked').length; }
    function calcDevTotal() { const rows = document.querySelectorAll('#self-dev-table tbody tr'); let hrs = 0; rows.forEach(r => hrs += Number(r.querySelector('.dev-hr').value || 0)); document.getElementById('dev-count').innerText = rows.length; document.getElementById('dev-hrs').innerText = hrs; }

    function addAchieveRow(id){ const n=id.includes('t1')?1:2; document.querySelector(`#${id} tbody`).insertAdjacentHTML('beforeend', `<tr><td class="row-index text-center font-bold"></td><td><textarea rows="1" class="text-left w-full"></textarea></td><td><input type="text" class="w-12"></td><td><input type="number" readonly class="bg-gray-100 font-bold"></td>${[4,3.5,3,2.5,2,1.5,1,0,'ร','มส'].map(x=>`<td><input type="number" oninput="calcAchieve('${id}')"></td>`).join('')}<td><button onclick="del(this)" class="text-red-400 px-1 font-bold">x</button></td></tr>`); reIndex(id); }
    function calcAchieve(id) {
        const sem = id.includes('t1') ? 't1' : 't2';
        let totals = {all:0, g4:0, g35:0, g3:0, g25:0, g2:0, g15:0, g1:0, g0:0, gr:0, gms:0};
        document.querySelectorAll(`#${id} tbody tr`).forEach(tr => {
            const inps = tr.querySelectorAll('input[type=number]'); 
            let rowSum = 0; for(let i=1; i<=10; i++) rowSum += Number(inps[i].value || 0);
            inps[0].value = rowSum;
            totals.all += rowSum; totals.g4 += Number(inps[1].value||0); totals.g35 += Number(inps[2].value||0); totals.g3 += Number(inps[3].value||0); totals.g25 += Number(inps[4].value||0); totals.g2 += Number(inps[5].value||0); totals.g15 += Number(inps[6].value||0); totals.g1 += Number(inps[7].value||0); totals.g0 += Number(inps[8].value||0); totals.gr += Number(inps[9].value||0); totals.gms += Number(inps[10].value||0);
        });
        document.getElementById(`${sem}-total-std`).innerText = totals.all;
        ['g4','g35','g3','g25','g2','g15','g1','g0','gr','gms'].forEach(k => document.getElementById(`${sem}-${k}`).innerText = totals[k]);
        ['p4','p35','p3','p25','p2','p15','p1','p0','pr','pms'].forEach((k, idx) => { const key = Object.keys(totals)[idx+1]; const pct = totals.all ? ((totals[key]/totals.all)*100).toFixed(2) : "0.00"; document.getElementById(`${sem}-${k}`).innerText = pct + "%"; });
        const g2up = totals.g4 + totals.g35 + totals.g3 + totals.g25 + totals.g2; const pct2 = totals.all ? ((g2up/totals.all)*100).toFixed(2) : "0.00";
        const g3up = totals.g4 + totals.g35 + totals.g3; const pct3 = totals.all ? ((g3up/totals.all)*100).toFixed(2) : "0.00";
        document.getElementById(`${sem}-kpi-2`).innerText = `${g2up} คน (${pct2}%)`; document.getElementById(`${sem}-kpi-3`).innerText = `${g3up} คน (${pct3}%)`;
        const target = Number(document.getElementById(`${sem}-target`).value || 0); const resEl = document.getElementById(`${sem}-judge`);
        if(Number(pct3) >= target) { resEl.innerText = "บรรลุ"; resEl.className="font-bold px-2 py-1 rounded text-white text-xs bg-green-500"; } else { resEl.innerText = "ไม่บรรลุ"; resEl.className="font-bold px-2 py-1 rounded text-white text-xs bg-red-500"; }
        updateChart(id.includes('t1')?1:2, totals);
    }
    
    // --- Charts ---
    let charts={};
    function updateChart(n, t){
        const ctx=document.getElementById('chart'+n); if(charts[n]) charts[n].destroy();
        charts[n] = new Chart(ctx, { type: 'bar', data: { labels: ['4','3.5','3','2.5','2','1.5','1','0','ร','มส'], datasets: [{ label:'จำนวน', data:[t.g4,t.g35,t.g3,t.g25,t.g2,t.g15,t.g1,t.g0,t.gr,t.gms], backgroundColor:'#e11d48' }] }, options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} } });
        setTimeout(()=>{ document.getElementById(`ach${n}_chart`).value = charts[n].toBase64Image(); }, 500);
    }

    // --- Evaluations ---
    function createEvalTable(id, title) { return `<div class="border rounded-lg p-3 bg-gray-50"><h5 class="font-bold text-gray-700 mb-2">${title}</h5><div class="overflow-x-auto border rounded-lg bg-white"><table class="w-full k-table text-xs" id="${id}"><thead><tr><th class="w-8">ที่</th><th class="min-w-subject">รายวิชา</th><th class="w-20">ห้อง</th><th class="w-20">รวม</th><th class="w-eval-col">3 (ดีเยี่ยม)</th><th class="w-eval-col">2 (ดี)</th><th class="w-eval-col">1 (ผ่าน)</th><th class="w-eval-col">0 (ไม่ผ่าน)</th><th class="w-6"></th></tr></thead><tbody></tbody><tfoot class="bg-gray-100 font-bold"><tr><td colspan="3" class="text-right pr-2">รวม</td><td id="${id}-total">0</td><td id="${id}-l3">0</td><td id="${id}-l2">0</td><td id="${id}-l1">0</td><td id="${id}-l0">0</td><td></td></tr></tfoot></table></div><button type="button" onclick="addEvalRow('${id}')" class="text-xs text-rose-600 mt-1 font-bold">+ เพิ่มวิชา</button><div class="mt-2 text-xs border-t pt-2 space-y-1"><div>ผลการประเมิน (ระดับ 2 ขึ้นไป): <span id="${id}-pass-pct" class="font-bold text-blue-600">0%</span></div><div>ระดับคุณภาพ: <span id="${id}-qual" class="font-bold px-2 py-0.5 rounded text-white bg-gray-400">-</span></div></div></div>`; }
    function addEvalRow(id){ document.querySelector(`#${id} tbody`).insertAdjacentHTML('beforeend', `<tr><td class="row-index text-center"></td><td><textarea rows="1" class="text-left w-full"></textarea></td><td><input type="text"></td><td><input type="number" readonly class="bg-gray-100 font-bold"></td>${[3,2,1,0].map(x=>`<td><input type="number" oninput="calcEvalTotal('${id}')"></td>`).join('')}<td><button onclick="del(this)" class="text-red-400">x</button></td></tr>`); reIndex(id); }
    function calcEvalTotal(id) {
        let t={all:0, l3:0, l2:0, l1:0, l0:0};
        document.querySelectorAll(`#${id} tbody tr`).forEach(tr => { const inps = tr.querySelectorAll('input[type=number]'); let sum = 0; for(let i=1;i<=4;i++) sum+=Number(inps[i].value||0); inps[0].value = sum; t.all += sum; t.l3 += Number(inps[1].value||0); t.l2 += Number(inps[2].value||0); t.l1 += Number(inps[3].value||0); t.l0 += Number(inps[4].value||0); });
        ['total','l3','l2','l1','l0'].forEach(k => { let val = 0; if(k === 'total') val = t.all; else val = t[k]; document.getElementById(`${id}-${k}`).innerText = val; });
        const pass = t.l3 + t.l2; const pp = t.all ? ((pass/t.all)*100).toFixed(2) : 0;
        document.getElementById(`${id}-pass-pct`).innerText = `${pass} คน (${pp}%)`;
        let qual = ""; let color = "";
        if(pp >= 90) { qual = "ยอดเยี่ยม"; color = "bg-purple-600"; } else if(pp >= 80) { qual = "ดีเลิศ"; color = "bg-green-600"; } else if(pp >= 70) { qual = "ดี"; color = "bg-blue-600"; } else if(pp >= 60) { qual = "ปานกลาง"; color = "bg-yellow-500"; } else { qual = "กำลังพัฒนา"; color = "bg-red-500"; }
        const qEl = document.getElementById(`${id}-qual`); qEl.innerText = qual; qEl.className = `font-bold px-2 py-0.5 rounded text-white ${color}`;
    }

    // --- Init ---
    function createThaiDateSelectors(hid, cid, callback){ const el=document.getElementById(cid); if(!el) return; el.innerHTML=`<select class="k-select w-24 d"><option value="">วัน</option>${Array.from({length:31},(_,i)=>`<option>${i+1}</option>`).join('')}</select><select class="k-select w-32 m"><option value="">เดือน</option>${['มกราคม','กุมภาพันธ์','มีนาคม','เมษายน','พฤษภาคม','มิถุนายน','กรกฎาคม','สิงหาคม','กันยายน','ตุลาคม','พฤศจิกายน','ธันวาคม'].map((m,i)=>`<option value="${i+1}">${m}</option>`).join('')}</select><select class="k-select w-28 y"><option value="">พ.ศ.</option>${Array.from({length:60},(_,i)=>`<option>${new Date().getFullYear()+543-i}</option>`).join('')}</select>`; el.querySelectorAll('select').forEach(s=>s.onchange=()=>{const d=el.querySelector('.d').value,m=el.querySelector('.m').value,y=el.querySelector('.y').value; const ms=["มกราคม","กุมภาพันธ์","มีนาคม","เมษายน","พฤษภาคม","มิถุนายน","กรกฎาคม","สิงหาคม","กันยายน","ตุลาคม","พฤศจิกายน","ธันวาคม"]; if(d&&m&&y){document.getElementById(hid).value=`${d} ${ms[parseInt(m)-1]} ${y}`; if(callback)callback(d,m,y);}}); }
    function updatePlanEval() { let t=0; document.querySelectorAll('.plan-group').forEach(g => { const c=g.querySelectorAll('input:checked').length; t+=(c===5?4:c===4?3:c===3?2:c>=1?1:0); }); document.getElementById('plan-eval-total').innerText=t; document.getElementById('plan-eval-level').innerText=t>=16?"ระดับ 4 (ดีมาก)":t>=11?"ระดับ 3 (ดี)":t>=6?"ระดับ 2 (พอใช้)":"ระดับ 1 (ปรับปรุง)"; }
    function calcStd(id) { let s=0,c=0; document.querySelectorAll(`#${id}-container input[type=number]`).forEach(i=>{if(i.value){s+=Number(i.value);c++}}); const a=c?(s/c).toFixed(2):0; document.getElementById(`${id}-score`).innerText=a; document.getElementById(`${id}-result`).innerText=a>4.5?"ยอดเยี่ยม":a>3.5?"ดีเลิศ":a>2.5?"ดี":a>1.5?"ปานกลาง":a>0?"กำลังพัฒนา":"-"; }

    window.onload = () => {
        try {
            createThaiDateSelectors('birthdate', 'birthdate-container', calcAge);
            createThaiDateSelectors('workdate', 'workdate-container', calcService);
            addRow('edu-table'); addTeachRow('teach-t1'); addTeachRow('teach-t2'); 
            addActRow('act-t1'); addActRow('act-t2'); addSpRow();
            addPlanRow(); addMediaRow(); addIntegRow(); addResRow(); addResourceRow();
            addDevRow(); addAwardRow('student-award-table',1); addAwardRow('teacher-award-table',0);
            addAchieveRow('achieve-t1'); addAchieveRow('achieve-t2'); 
            const attrWrap = document.getElementById('attr-wrapper'); if(attrWrap) attrWrap.innerHTML = createEvalTable('attr-t1','ภาคเรียนที่ 1') + createEvalTable('attr-t2','ภาคเรียนที่ 2');
            const readWrap = document.getElementById('read-wrapper'); if(readWrap) readWrap.innerHTML = createEvalTable('read-t1','ภาคเรียนที่ 1') + createEvalTable('read-t2','ภาคเรียนที่ 2');
            if(document.getElementById('attr-t1')) { addEvalRow('attr-t1'); addEvalRow('attr-t2'); }
            if(document.getElementById('read-t1')) { addEvalRow('read-t1'); addEvalRow('read-t2'); }
            
            // Methods Init
            const methods = ["การอธิบาย","การสาธิต / ทดลอง","การใช้เกมประกอบ","สถานการณ์จำลอง","กรณีตัวอย่าง","บทบาทสมมุติ","การแก้ไขสถานการณ์","โปรแกรมสำเร็จรูป","ศูนย์การเรียน","ชุดการสอน","คอมพิวเตอร์ช่วยสอน","โครงงาน","การถามตอบ","การสืบสวนสอบสวน","กลุ่มสืบค้นความรู้","กลุ่มสัมพันธ์","การเรียนรู้แบบร่วมมือ","ความคิดรวบยอด","อริยสัจ 4","การศึกษาค้นคว้าด้วยตนเอง","การทัศนะศึกษานอกสถานที่","การเรียนรู้จากห้องสมุด","การพัฒนากระบวนการคิด","การอภิปรายกลุ่มย่อย","การแก้ปัญหา"];
            const methodContainer = document.getElementById('methods-wrap');
            if(methodContainer) methodContainer.innerHTML = methods.map((m,i)=>`<label class="flex items-center gap-2 cursor-pointer hover:bg-white p-2 rounded"><input type="checkbox" name="methods" value="${m}" data-idx="${i+1}" onchange="updateMethodCount()" class="accent-rose-600 w-4 h-4"> ${m}</label>`).join('');
            
            // Plan Eval Init
            const p7Data = [{t:'7.1 การวิเคราะห์ มาตรฐานฯ', i:['ระบุตัวชี้วัด/ผลการเรียนรู้','วิเคราะห์ KPA','เหมาะสม สอดคล้องกิจกรรม','สอดคล้องผลการเรียนรู้','ครอบคลุมมาตรฐาน']}, {t:'7.2 การออกแบบกิจกรรม', i:['ออกแบบเป็นขั้นตอน','ครบ 4 ด้าน','เหมาะสมกับจุดประสงค์','สอดคล้อง KPA','ปฏิบัติได้จริง']}, {t:'7.3 การออกแบบปฏิสัมพันธ์', i:['กระบวนการกลุ่ม','มีส่วนร่วมหลากหลาย','กำหนดบทบาทชัดเจน','ปฏิบัติจริง','ผู้เรียนสนุกสนาน']}, {t:'7.4 การออกแบบประเมินผล', i:['ประเมินทุกแผน','ประเมินหลากหลาย','สอดคล้องจุดประสงค์','ปฏิบัติจริง','นำผลมาพัฒนา']}, {t:'7.5 การใช้สื่ออุปกรณ์', i:['มีการใช้สื่อ','กำหนดขั้นตอนการใช้','เหมาะสมกับกิจกรรม','มีสื่ออุปกรณ์','พัฒนาสื่อ']}];
            const p7Container = document.getElementById('plan-eval-container');
            if(p7Container) p7Container.innerHTML = p7Data.map((s, idx) => `<div class="border rounded-lg p-4 bg-gray-50 plan-group" id="plan_group_${idx+1}"><h4 class="font-bold text-gray-700 mb-2">${s.t}</h4><div class="grid grid-cols-1 md:grid-cols-2 gap-2">${s.i.map((item, subIdx) => `<label class="flex items-center gap-2"><input type="checkbox" name="plan${idx+1}_${subIdx+1}" onchange="updatePlanEval()" class="accent-rose-600 w-4 h-4"> <span class="text-sm">${item}</span></label>`).join('')}</div></div>`).join('');
            
            // Standards Init
            const stdData = [ {id:'std1', t:'มาตรฐานที่ 1 คุณภาพของผู้เรียน', sub:[ {n:'1.1 ผลสัมฤทธิ์ทางวิชาการ', i:['ความสามารถในการอ่าน เขียน สื่อสาร คิดคำนวณ','คิดวิเคราะห์ วิจารณญาณ แก้ปัญหา','สร้างนวัตกรรม','ใช้เทคโนโลยีสารสนเทศ','ผลสัมฤทธิ์ตามหลักสูตร','ความรู้ทักษะพื้นฐาน เจตคติงานอาชีพ']}, {n:'1.2 คุณลักษณะที่พึงประสงค์', i:['คุณลักษณะค่านิยมที่ดี','ภูมิใจในท้องถิ่นและความเป็นไทย','ยอมรับความแตกต่าง','สุขภาวะทางร่างกาย จิตสังคม']} ]}, {id:'std2', t:'มาตรฐานที่ 2 กระบวนการบริหารและการจัดการ', sub:[ {n:'', i:['เป้าหมายวิสัยทัศน์ชัดเจน','ระบบบริหารจัดการคุณภาพ','พัฒนาวิชาการเน้นคุณภาพผู้เรียน','พัฒนาครูให้เชี่ยวชาญ','สภาพแวดล้อมเอื้อต่อการเรียนรู้','ระบบเทคโนโลยีสารสนเทศ']} ]}, {id:'std3', t:'มาตรฐานที่ 3 กระบวนการจัดการเรียนการสอนที่เน้นผู้เรียนเป็นสำคัญ', sub:[ {n:'', i:['จัดการเรียนรู้ผ่านกระบวนการคิด','ใช้สื่อ เทคโนโลยี','บริหารจัดการชั้นเรียนเชิงบวก','ตรวจสอบและประเมินผู้เรียน','แลกเปลี่ยนเรียนรู้และสะท้อนกลับ']} ]} ];
            const stdContainer = document.getElementById('std-container');
            if(stdContainer) stdContainer.innerHTML = stdData.map(s => `<div class="border rounded-xl overflow-hidden mb-6" id="${s.id}-container"><div class="bg-gray-100 p-4 border-b flex justify-between items-center"><h3 class="font-bold text-lg text-gray-800">${s.t}</h3><div class="text-right"><div class="text-sm text-gray-500">เฉลี่ย</div><div id="${s.id}-score" class="font-bold text-xl text-rose-600">0.00</div><div id="${s.id}-result" class="text-sm font-bold text-blue-600">-</div></div></div><div class="p-4 bg-white space-y-4">${s.sub.map(sub => `${sub.n?`<h4 class="font-bold text-gray-700 bg-gray-50 p-2 rounded">${sub.n}</h4>`:''} <div class="space-y-2 pl-2">${sub.i.map(item => `<div class="flex justify-between items-center border-b border-dashed pb-1"><span class="text-sm text-gray-600 w-3/4">${item}</span><input type="number" min="1" max="5" class="border rounded w-16 text-center p-1" oninput="calcStd('${s.id}')" placeholder="1-5"></div>`).join('')}</div>`).join('')}<div class="grid md:grid-cols-2 gap-4 mt-4 pt-4 border-t"><div><label class="k-label">กระบวนการพัฒนา</label><textarea class="w-full border rounded p-2 text-sm" rows="3"></textarea></div><div><label class="k-label">ผลการพัฒนา</label><textarea class="w-full border rounded p-2 text-sm" rows="3"></textarea></div><div><label class="k-label">จุดเด่น</label><textarea class="w-full border rounded p-2 text-sm" rows="3"></textarea></div><div><label class="k-label">จุดที่ควรพัฒนา</label><textarea class="w-full border rounded p-2 text-sm" rows="3"></textarea></div></div></div></div>`).join('');
            
            const nameInput = document.querySelector('input[name="full_name"]'); if(nameInput) { nameInput.addEventListener('input', function(e) { document.getElementById('signer_name').innerText = e.target.value || '-'; }); }
            showTab(1);
            
            // Check Draft
            const saved = localStorage.getItem('sar_draft');
            if(saved) {
                Swal.fire({
                    title: 'พบข้อมูลแบบร่าง',
                    text: 'ต้องการเรียกคืนข้อมูลที่บันทึกไว้ล่าสุดหรือไม่?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: 'เรียกคืน',
                    cancelButtonText: 'เริ่มใหม่'
                }).then((result) => {
                    if (result.isConfirmed) { loadDraft(saved); }
                });
            }
        } catch (e) { console.error("Init Error: ", e); }
    }
    
    // --- Save Draft (LocalStorage) ---
    function saveDraft() {
        const d = {};
        const fd = new FormData(document.getElementById('sarForm'));
        for(let [k,v] of fd.entries()) d[k] = v;
        
        // Save table row counts
        d._tables = {};
        ['edu-table','teach-t1','teach-t2','act-t1','act-t2','sp-table','plan-table','media-table-new','inter-table','res-table','learning-resources-table','self-dev-table','student-award-table','teacher-award-table','achieve-t1','achieve-t2','attr-t1','attr-t2','read-t1','read-t2'].forEach(id => {
             d._tables[id] = document.querySelectorAll(`#${id} tbody tr`).length;
        });
        
        // Save Checkboxes
        d._checks = [];
        document.querySelectorAll('input[type=checkbox]:checked').forEach(cb => d._checks.push(cb.name || cb.value));

        localStorage.setItem('sar_draft', JSON.stringify(d));
        Swal.fire({ icon: 'success', title: 'บันทึกแบบร่างแล้ว', timer: 1500, showConfirmButton: false });
    }
    
    // --- Load Draft ---
    function loadDraft(jsonStr) {
        try {
            const d = JSON.parse(jsonStr);
            if(d._tables) {
                Object.keys(d._tables).forEach(id => {
                    const count = d._tables[id];
                    const current = document.querySelectorAll(`#${id} tbody tr`).length;
                    for(let i=current; i<count; i++) {
                         if(id==='edu-table') addRow('edu-table');
                         else if(id==='teach-t1') addTeachRow('teach-t1');
                         else if(id==='teach-t2') addTeachRow('teach-t2');
                         else if(id==='act-t1') addActRow('act-t1');
                         else if(id==='act-t2') addActRow('act-t2');
                         else if(id==='sp-table') addSpRow();
                         else if(id==='plan-table') addPlanRow();
                         else if(id==='media-table-new') addMediaRow();
                         else if(id==='inter-table') addIntegRow();
                         else if(id==='res-table') addResRow();
                         else if(id==='learning-resources-table') addResourceRow('learning-resources-table');
                         else if(id==='self-dev-table') addDevRow();
                         else if(id==='student-award-table') addAwardRow('student-award-table',1);
                         else if(id==='teacher-award-table') addAwardRow('teacher-award-table',0);
                         else if(id==='achieve-t1') addAchieveRow('achieve-t1');
                         else if(id==='achieve-t2') addAchieveRow('achieve-t2');
                         else if(id.includes('attr') || id.includes('read')) addEvalRow(id);
                    }
                });
            }

            Object.keys(d).forEach(k => {
                if(k.startsWith('_')) return;
                const el = document.querySelector(`[name="${k}"]`);
                if(el) {
                   if(el.type !== 'file') el.value = d[k];
                   if(el.oninput) el.oninput();
                   if(el.onchange) el.onchange();
                }
            });
            
             if(d._checks) {
                 d._checks.forEach(val => {
                     const cb = document.querySelector(`input[value="${val}"]`) || document.querySelector(`input[name="${val}"]`);
                     if(cb) { cb.checked = true; if(cb.onchange) cb.onchange(); }
                 });
             }
             
             if(d.profile_pic) { document.getElementById('pf_preview').src = d.profile_pic; document.getElementById('pf_preview').classList.remove('hidden'); }
             if(d.signature_img) { document.getElementById('sig_preview_manual').src = d.signature_img; document.getElementById('sig_preview_manual').classList.remove('hidden'); document.getElementById('sig_placeholder').style.display='none'; }

        } catch(e) { console.error("Restore Error", e); }
    }

    // --- PDF Export (Client Side) ---
    function exportPDFClient() {
        const original = document.getElementById('sarForm');
        const clone = original.cloneNode(true);
        
        // Expand Tabs
        clone.querySelectorAll('.tab-content').forEach(el => {
            el.style.display = 'block';
            el.style.opacity = '1';
            el.style.animation = 'none';
        });
        
        // Remove Buttons inside clone
        clone.querySelectorAll('button').forEach(el => el.remove());
        
        const wrapper = document.createElement('div');
        wrapper.style.padding = '20px';
        wrapper.style.width = '100%';
        wrapper.appendChild(clone);
        
        html2pdf().from(wrapper).set({
            margin: 10,
            filename: 'SAR_Report.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
        }).save();
    }

    // --- Submission Simulation ---
    function submitData(){
        Swal.fire({
            title: 'Simulation Mode',
            text: 'ระบบนี้เป็น GitHub Page (Static) ข้อมูลจะไม่ถูกส่งไปยัง Google Drive จริง แต่ท่านสามารถ Save Draft หรือ Export PDF ได้',
            icon: 'info',
            confirmButtonText: 'เข้าใจแล้ว'
        });
    }
</script>
</body>
</html>
